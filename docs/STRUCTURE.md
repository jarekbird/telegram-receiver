# Project Structure Documentation

This document provides a comprehensive overview of the telegram-receiver project structure, including directory organization, file purposes, and architectural patterns. This documentation helps developers understand the codebase organization and navigate the project effectively.

## Table of Contents

- [Root-Level Structure](#root-level-structure)
- [Source Code Structure (`src/`)](#source-code-structure-src)
- [Test Structure (`tests/`)](#test-structure-tests)
- [Configuration Files](#configuration-files)
- [Other Important Directories](#other-important-directories)
- [File Naming Conventions](#file-naming-conventions)
- [Architectural Patterns](#architectural-patterns)
- [Rails-to-Node.js Conversion Notes](#rails-to-nodejs-conversion-notes)

---

## Root-Level Structure

### Core Files

#### `package.json`

Project dependencies and scripts. Defines:

- **Dependencies**: Runtime dependencies including Express.js, BullMQ, Redis clients, Axios, and Pino logger
- **DevDependencies**: Development tools including TypeScript, Jest, Playwright, ESLint, Prettier, and testing libraries
- **Scripts**: Common npm commands for building, testing, linting, formatting, and running the application
  - `npm run build` - Compiles TypeScript to JavaScript
  - `npm run dev` - Runs development server with hot reload
  - `npm test` - Runs Jest unit and integration tests
  - `npm run test:e2e` - Runs Playwright end-to-end tests
  - `npm run lint` - Checks code for linting errors
  - `npm run format` - Formats code with Prettier

#### `package-lock.json`

Dependency lock file that ensures consistent dependency versions across installations. This file is automatically generated and should be committed to version control.

#### `deploy.sh`

Deployment script for testing and pushing changes. The script:

1. Verifies the correct directory
2. Runs linting checks (`npm run lint`)
3. Checks code formatting (`npm run format:check`)
4. Runs all tests (`npm test`)
5. Generates test coverage (`npm run test:coverage`)
6. Automatically stages and commits changes with an AI-generated commit message
7. Pushes changes to the remote repository

**Important**: Always use `./deploy.sh` instead of manually committing and pushing to ensure all checks pass before deployment.

### Environment Files

#### `.env.example`

Environment configuration template showing all required and optional environment variables. This file serves as documentation for required configuration and should be copied to create local `.env` files.

#### `.env.development`

Development environment configuration file. Contains development-specific settings and should not be committed to version control.

#### `.env.test`

Test environment configuration file. Contains test-specific settings used when running tests.

**Note**: Actual `.env` files (without `.example`, `.development`, or `.test` suffixes) are gitignored and should not be committed to version control.

### TypeScript Configuration Files

#### `tsconfig.json`

Main TypeScript compiler configuration. Key settings:

- **Target**: ES2022
- **Module**: CommonJS
- **Output Directory**: `./dist`
- **Root Directory**: `./src`
- **Strict Mode**: Enabled for type safety
- **Path Aliases**: `@/*` maps to `./src/*` for cleaner imports

#### `tsconfig.eslint.json`

TypeScript configuration specifically for ESLint. Extends the main `tsconfig.json` and is used by ESLint's TypeScript parser to understand type information for linting rules.

#### `tsconfig.test.json`

TypeScript configuration for test files. May include relaxed type checking rules for test code if needed.

### Code Quality Configuration Files

#### `.eslintrc.json`

ESLint linting rules configuration. Key features:

- Uses TypeScript ESLint parser and plugins
- Extends recommended TypeScript rules
- Integrates with Prettier for formatting
- Enforces no console.log/debugger statements
- Warns on `any` types
- Configures unused variable patterns

#### `.prettierrc.json`

Prettier code formatting rules. Defines:

- Single quotes
- Semicolons enabled
- 100 character print width
- 2 space indentation
- Trailing commas (ES5 style)

### Build and Runtime Files

#### `node_modules/`

Directory containing all npm package dependencies. This directory is gitignored and should not be committed to version control. Dependencies are installed via `npm install` using `package.json` and `package-lock.json`.

#### `dist/`

Compiled JavaScript output directory. Contains the transpiled TypeScript code after running `npm run build`. This directory is gitignored and generated during the build process.

---

## Source Code Structure (`src/`)

The `src/` directory contains all application source code written in TypeScript. The structure follows a layered architecture pattern with clear separation of concerns.

### `src/index.ts`

Application entry point. This file:

- Validates environment configuration before starting
- Initializes and starts the HTTP server
- Handles graceful shutdown on SIGTERM/SIGINT signals
- Manages uncaught exceptions and unhandled promise rejections
- Sets up error handling for server startup failures

### `src/app.ts`

Express application setup and configuration. This file:

- Creates the Express application instance
- Configures middleware (CORS, body parsers, request logging)
- Registers route handlers
- Sets up error handling middleware
- Exports the configured Express app

### `src/config/`

Configuration files and settings management.

#### `src/config/environment.ts`

Environment variable management and configuration object. Centralizes access to all environment variables and provides typed configuration values.

#### `src/config/logger.ts`

Logger configuration and setup. Configures Pino logger with appropriate settings for different environments (development, test, production).

#### `src/config/validateEnv.ts`

Environment validation logic. Validates that all required environment variables are present and have valid values before the application starts.

### `src/controllers/`

Request handlers and route controllers. Controllers handle HTTP requests and responses, following the MVC pattern.

#### `src/controllers/health.controller.ts`

Health check endpoint controller. Handles GET requests to `/health` and `/` endpoints, returning application status information.

**Pattern**: Controllers are organized by feature/domain. Each controller file exports handler functions that are used by route definitions.

### `src/middleware/`

Express middleware functions. Middleware handles cross-cutting concerns like CORS, logging, error handling, and request parsing.

#### `src/middleware/cors.ts`

CORS (Cross-Origin Resource Sharing) middleware configuration. Handles CORS headers and preflight OPTIONS requests. Disabled by default, can be enabled via `CORS_ENABLED` environment variable.

#### `src/middleware/error-handler.middleware.ts`

Global error handling middleware. Catches all unhandled errors and returns standardized error responses matching Rails error response format.

#### `src/middleware/not-found.middleware.ts`

404 Not Found handler middleware. Catches all requests that don't match any registered routes and returns a standardized 404 response.

#### `src/middleware/request-logger.middleware.ts`

Request logging middleware. Logs incoming HTTP requests and their responses using the configured logger.

**Pattern**: Middleware functions are exported and applied in `app.ts` in the correct order (CORS → body parsers → request logger → routes → 404 handler → error handler).

### `src/models/`

Data models and database entities. Currently empty but reserved for future model definitions when database integration is added.

**Pattern**: Models will represent data structures and may include validation, serialization, and database interaction logic.

### `src/routes/`

Route definitions and endpoint mappings. Routes define URL patterns and map them to controller handlers.

#### `src/routes/health.routes.ts`

Health check route definitions. Defines the `/health` endpoint and maps it to the health controller.

**Pattern**: Routes are organized by feature/domain. Each route file exports an Express Router instance that is registered in `app.ts`.

### `src/services/`

Business logic and external service integrations. Currently empty but reserved for service layer implementations.

**Pattern**: Services will contain:

- Business logic that doesn't belong in controllers
- External API integrations (Telegram Bot API, Cursor Runner API, ElevenLabs API)
- Complex data processing and transformation
- Reusable business operations

### `src/types/`

TypeScript type definitions and interfaces. Contains type definitions for external APIs and internal data structures.

#### `src/types/cursor-runner.ts`

Type definitions for Cursor Runner API requests and responses.

#### `src/types/telegram.ts`

Type definitions for Telegram Bot API updates, messages, and other Telegram-related data structures.

**Pattern**: Types are organized by external service or domain. Shared types may be placed in a common location.

### `src/utils/`

Utility functions and helpers. Contains reusable utility functions used throughout the application.

#### `src/utils/logger.ts`

Logger utility. Provides a configured logger instance that can be imported and used throughout the application.

**Pattern**: Utilities are pure functions or simple modules that don't depend on application state. They should be easily testable and reusable.

### Other `src/` Subdirectories

#### `src/errors/`

Custom error classes. Reserved for application-specific error types that extend JavaScript's Error class.

#### `src/jobs/`

Background job definitions. Reserved for BullMQ job processors and job definitions.

#### `src/validators/`

Input validation schemas and validators. Reserved for request validation logic using libraries like Joi or Zod.

#### `src/worker.ts`

Background worker entry point. Separate entry point for running background job processors (BullMQ workers) independently from the main HTTP server.

---

## Test Structure (`tests/`)

The `tests/` directory contains all test files organized by test type. Tests are written using Jest for unit and integration tests, and Playwright for end-to-end tests.

### `tests/setup.ts`

Test configuration and setup. This file:

- Configures Jest test environment
- Sets up global test utilities and mocks
- Configures test timeouts and other Jest settings
- Runs before all test suites

### `tests/unit/`

Unit tests organized by source structure. Unit tests test individual functions, classes, and modules in isolation.

#### `tests/unit/config/`

Unit tests for configuration modules:

- `environment.test.ts` - Tests environment configuration
- `logger.test.ts` - Tests logger setup and configuration
- `validateEnv.test.ts` - Tests environment validation logic

#### `tests/unit/controllers/`

Unit tests for controller functions. Currently empty but reserved for controller tests.

#### `tests/unit/middleware/`

Unit tests for middleware functions:

- `cors.test.ts` - Tests CORS middleware behavior
- `not-found.middleware.test.ts` - Tests 404 handler middleware
- `request-logger.middleware.test.ts` - Tests request logging middleware

#### `tests/unit/routes/`

Unit tests for route definitions:

- `health.routes.test.ts` - Tests health check routes

#### `tests/unit/services/`

Unit tests for service classes. Currently empty but reserved for service tests.

#### `tests/unit/utils/`

Unit tests for utility functions:

- `example.test.ts` - Example utility test

**Pattern**: Unit test directory structure mirrors the `src/` directory structure for easy navigation. Each source file should have a corresponding test file.

### `tests/integration/`

Integration tests for API and services. Integration tests test how multiple modules/components work together.

#### `tests/integration/api/`

Integration tests for API endpoints:

- `health.test.ts` - Integration tests for health check endpoints

#### `tests/integration/services/`

Integration tests for service interactions. Currently empty but reserved for service integration tests.

**Pattern**: Integration tests use Supertest to make actual HTTP requests to the Express application and verify end-to-end request/response behavior.

### `tests/e2e/`

End-to-end tests using Playwright. E2E tests test complete user workflows in a real browser environment.

**Pattern**: E2E tests simulate real user interactions and test the application as a whole, including frontend (if applicable) and backend interactions.

### `tests/fixtures/`

Test data and fixtures. Contains reusable test data and mock responses.

#### `tests/fixtures/apiResponses.ts`

Mock API responses for external services (Telegram, Cursor Runner, etc.).

#### `tests/fixtures/telegramMessages.ts`

Sample Telegram message payloads for testing.

**Pattern**: Fixtures provide consistent, realistic test data that can be reused across multiple tests.

### `tests/helpers/`

Test utility functions. Contains helper functions and utilities used in tests.

#### `tests/helpers/apiHelpers.ts`

Helper functions for making API requests in tests.

#### `tests/helpers/testUtils.ts`

General test utilities and helper functions.

**Pattern**: Test helpers reduce code duplication and provide convenient utilities for common test operations.

### `tests/mocks/`

Mock implementations for external services. Contains mocks for external APIs and services used in tests.

#### `tests/mocks/cursorRunnerApi.ts`

Mock implementation of Cursor Runner API client.

#### `tests/mocks/redis.ts`

Mock implementation of Redis client.

#### `tests/mocks/telegramApi.ts`

Mock implementation of Telegram Bot API client.

**Pattern**: Mocks isolate the code under test from external dependencies, making tests faster and more reliable.

---

## Configuration Files

### Test Configuration

#### `jest.config.ts`

Jest test runner configuration. Defines:

- Test environment (Node.js)
- Test file patterns and locations
- Coverage collection settings
- Module path mappings (`@/*` → `src/*`)
- Setup files and test timeouts
- Coverage reporters (text, lcov, html)

#### `playwright.config.ts`

Playwright E2E test configuration. Defines:

- Test directory (`./tests/e2e`)
- Browser projects (Chromium)
- Base URL for tests
- Web server configuration for running dev server during tests
- Retry and parallel execution settings

### Docker Configuration

#### `Dockerfile`

Docker container configuration for building and running the Node.js application in a containerized environment.

#### `docker-compose.yml`

Docker Compose configuration for local development. Defines services, networks, and volumes needed for development.

#### `docker-compose.prod.yml`

Docker Compose configuration for production deployment.

#### `docker-entrypoint.sh`

Docker entrypoint script that runs when the container starts. Handles initialization tasks and starts the application.

---

## Other Important Directories

### `Plan/`

Conversion plan and task documentation. Contains:

- `app-description.md` - Application description and requirements
- `CONVERSION_STEPS.md` - Step-by-step conversion plan from Rails to Node.js
- `tasks/` - Detailed task breakdowns organized by phase and section
  - `phase-1/` - Basic Node.js API Infrastructure tasks
  - `phase-2/` - File-by-file conversion tasks
  - `phase-3/` - Holistic review and best practices tasks
  - `phase-4/` - Code quality audit tasks

**Purpose**: This directory tracks the conversion progress and provides detailed specifications for each conversion task.

### `agents/`

Agent role definitions for AI-assisted development.

#### `agents/Product Designer.md`

Product Designer agent role definition and instructions.

#### `agents/Software Developer.md`

Software Developer agent role definition and instructions. Defines:

- Task implementation workflow
- Testing requirements and best practices
- Code quality standards
- Deployment procedures using `deploy.sh`

**Purpose**: These files guide AI agents in following consistent development practices and workflows.

### `coverage/`

Test coverage reports generated by Jest. Contains:

- HTML coverage reports (`lcov-report/`)
- LCOV coverage data (`lcov.info`)
- Coverage visualization files

**Note**: This directory is gitignored and regenerated when running `npm run test:coverage`.

### `docs/`

Project documentation including:

- `STRUCTURE.md` - This file, documenting project structure
- `architecture.md` - Application architecture documentation
- `API.md` - API endpoint documentation
- `API_CONVENTIONS.md` - API design conventions and standards
- `manual-code-review.md` - Manual code review guidelines
- `ESLINT.md` - ESLint configuration and rules documentation
- `PRETTIER.md` - Prettier formatting rules documentation
- Review documents from Phase 3 and Phase 4 tasks

**Purpose**: Centralized location for all project documentation.

### `scripts/`

Utility scripts for development and deployment. Contains:

- TypeScript scripts for various tasks
- Shell scripts for automation
- Documentation for script usage

**Note**: One-time scripts should be placed in `/cursor/scripts` (shared directory), not in repository directories.

---

## File Naming Conventions

### TypeScript Files

- **Controllers**: `*.controller.ts` (e.g., `health.controller.ts`)
- **Routes**: `*.routes.ts` (e.g., `health.routes.ts`)
- **Middleware**: `*.middleware.ts` (e.g., `error-handler.middleware.ts`)
- **Services**: `*.service.ts` (e.g., `telegram.service.ts`)
- **Models**: `*.model.ts` or singular noun (e.g., `user.model.ts`)
- **Types**: `*.ts` with descriptive names (e.g., `telegram.ts`, `cursor-runner.ts`)
- **Utils**: `*.ts` with descriptive names (e.g., `logger.ts`)
- **Config**: `*.ts` with descriptive names (e.g., `environment.ts`)

### Test Files

- **Unit Tests**: `*.test.ts` (e.g., `health.controller.test.ts`)
- **Integration Tests**: `*.test.ts` in `tests/integration/` (e.g., `health.test.ts`)
- **E2E Tests**: `*.spec.ts` or `*.test.ts` in `tests/e2e/` (Playwright convention)

### Configuration Files

- **TypeScript Config**: `tsconfig*.json`
- **ESLint Config**: `.eslintrc.json`
- **Prettier Config**: `.prettierrc.json`
- **Jest Config**: `jest.config.ts`
- **Playwright Config**: `playwright.config.ts`

### General Conventions

- Use **kebab-case** for file names (e.g., `error-handler.middleware.ts`)
- Use **camelCase** for TypeScript identifiers (variables, functions, classes)
- Use **PascalCase** for class names and type names
- Use **UPPER_SNAKE_CASE** for constants and environment variables

---

## Architectural Patterns

### Layered Architecture

The application follows a layered architecture pattern:

1. **Routes Layer** (`src/routes/`): Defines URL patterns and HTTP methods
2. **Controller Layer** (`src/controllers/`): Handles HTTP requests and responses
3. **Service Layer** (`src/services/`): Contains business logic and external integrations
4. **Model Layer** (`src/models/`): Represents data structures (when database is added)
5. **Middleware Layer** (`src/middleware/`): Cross-cutting concerns (CORS, logging, error handling)

### Separation of Concerns

- **Controllers** are thin and delegate business logic to services
- **Services** contain reusable business logic and external API interactions
- **Routes** only define URL patterns and map to controllers
- **Middleware** handles cross-cutting concerns without business logic
- **Utils** contain pure functions and helpers

### Dependency Injection

- Services and utilities are imported where needed
- Dependencies are passed as function parameters or constructor arguments
- No global state or singletons (except for logger, which is a utility)

### Error Handling

- Errors are caught at the middleware level
- Custom error classes can be defined in `src/errors/`
- Error responses follow a consistent format matching Rails error responses
- Unhandled errors are logged and return generic error messages to clients

### Async/Await Pattern

- All asynchronous operations use `async/await` syntax
- Promises are properly handled with error catching
- Background jobs use BullMQ for queue management

---

## Rails-to-Node.js Conversion Notes

This project is a conversion from a Ruby on Rails application (`jarek-va`) to Node.js/TypeScript. The following mappings help understand the conversion:

### Framework Mappings

- **Rails Routes** → **Express Routes** (`src/routes/`)
- **Rails Controllers** → **Express Controllers** (`src/controllers/`)
- **Rails Services** → **Node.js Services** (`src/services/`)
- **Rails Models** → **TypeScript Types/Interfaces** (`src/types/`) and future Models (`src/models/`)
- **Rails Middleware** → **Express Middleware** (`src/middleware/`)
- **Rails Jobs (Sidekiq)** → **BullMQ Jobs** (`src/jobs/`)

### Key Differences

1. **No ActiveRecord**: Database interactions will use a lightweight ORM (TypeORM, Prisma) or direct database clients when added
2. **No ActiveJob**: Background jobs use BullMQ with Redis
3. **No Rails Credentials**: Configuration uses environment variables (`.env` files)
4. **TypeScript Types**: Strong typing replaces Ruby's duck typing
5. **Express Middleware**: Request/response handling uses Express middleware instead of Rails filters

### Preserved Functionality

- Same webhook authentication mechanism
- Same request forwarding logic
- Same callback handling flow
- Same error handling approach
- Same local command processing

### Conversion Status

- **Phase 1**: Basic Node.js API Infrastructure ✅ (In Progress)
- **Phase 2**: File-by-file conversion (Pending)
- **Phase 3**: Holistic review and best practices (Pending)
- **Phase 4**: Code quality audit (Pending)

See `Plan/CONVERSION_STEPS.md` for detailed conversion plan and `Plan/tasks/` for task breakdowns.

---

## Directory Purpose Summary

| Directory            | Purpose                                    |
| -------------------- | ------------------------------------------ |
| `src/`               | All application source code (TypeScript)   |
| `src/config/`        | Configuration and environment management   |
| `src/controllers/`   | HTTP request handlers                      |
| `src/middleware/`    | Express middleware functions               |
| `src/models/`        | Data models (reserved for future)          |
| `src/routes/`        | Route definitions                          |
| `src/services/`      | Business logic and external integrations   |
| `src/types/`         | TypeScript type definitions                |
| `src/utils/`         | Utility functions and helpers              |
| `tests/`             | All test files                             |
| `tests/unit/`        | Unit tests (mirrors `src/` structure)      |
| `tests/integration/` | Integration tests                          |
| `tests/e2e/`         | End-to-end tests                           |
| `tests/fixtures/`    | Test data and fixtures                     |
| `tests/helpers/`     | Test utility functions                     |
| `tests/mocks/`       | Mock implementations for external services |
| `docs/`              | Project documentation                      |
| `Plan/`              | Conversion plan and task documentation     |
| `agents/`            | AI agent role definitions                  |
| `coverage/`          | Test coverage reports (gitignored)         |
| `dist/`              | Compiled JavaScript output (gitignored)    |
| `node_modules/`      | npm dependencies (gitignored)              |

---

_Last Updated: 2024_
_This documentation is part of Phase 1, Section 12: API Structure Documentation_
