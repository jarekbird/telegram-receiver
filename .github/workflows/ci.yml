name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for diff comparison

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            CHANGED=$(git diff --name-only --diff-filter=ACMR $BASE_SHA..$HEAD_SHA | grep -E '\.ts$' || true)
          else
            # For pushes, compare against previous commit
            CHANGED=$(git diff --name-only --diff-filter=ACMR HEAD~1..HEAD | grep -E '\.ts$' || true)
          fi
          
          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changed files detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Changed files:"
            echo "$CHANGED" | while read file; do
              echo "  - $file"
            done
          fi

      - name: Run ESLint linter
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Linting changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            # Filter out test files for ESLint (only lint source files)
            SOURCE_FILES=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.ts$' || echo "")
            if [ -n "$SOURCE_FILES" ]; then
              echo "$SOURCE_FILES" | tr '\n' '\0' | xargs -0 npx eslint --max-warnings=0
            else
              echo "No source files changed, skipping ESLint"
            fi
          else
            echo "No files changed, linting all files..."
            npm run lint
          fi

      - name: Run Prettier format check
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Checking formatting for changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            if [ -n "$CHANGED_FILES" ]; then
              echo "$CHANGED_FILES" | tr '\n' '\0' | xargs -0 npx prettier --check
            else
              echo "No files changed, checking all files..."
              npm run format:check
            fi
          else
            echo "No files changed, checking all files..."
            npm run format:check
          fi

      - name: Run TypeScript type check
        run: npm run type-check

      - name: Run Jest tests
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Running tests for changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            # Get changed test files
            CHANGED_TESTS=$(echo "$CHANGED_FILES" | grep -E '^tests/.*\.(test|spec)\.ts$' || echo "")
            
            # Get changed source files (excluding test files)
            CHANGED_SOURCE=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.ts$' || echo "")
            
            # Collect all test files to run:
            # 1. Changed test files
            # 2. Related test files for changed source files
            ALL_TESTS="$CHANGED_TESTS"
            
            # Find related test files for changed source files
            if [ -n "$CHANGED_SOURCE" ]; then
              echo "Finding related test files for changed source files..."
              while IFS= read -r source_file; do
                [ -z "$source_file" ] && continue
                # Map src/**/*.ts to tests/**/*.test.ts or tests/**/*.spec.ts
                # Example: src/services/telegram_service.ts -> tests/**/services/telegram_service.test.ts
                # Get relative path from src/
                rel_path=$(echo "$source_file" | sed 's|^src/||' | sed 's|\.ts$||')
                
                # Check for test files in various test directories (unit, integration, etc.)
                # Try .test.ts first, then .spec.ts
                test_file=$(find tests -path "*/${rel_path}.test.ts" -type f 2>/dev/null | head -1)
                if [ -n "$test_file" ]; then
                  ALL_TESTS="${ALL_TESTS}${test_file} "
                else
                  spec_file=$(find tests -path "*/${rel_path}.spec.ts" -type f 2>/dev/null | head -1)
                  if [ -n "$spec_file" ]; then
                    ALL_TESTS="${ALL_TESTS}${spec_file} "
                  fi
                fi
              done <<< "$CHANGED_SOURCE"
            fi
            
            # Remove duplicates and empty entries
            ALL_TESTS=$(echo "$ALL_TESTS" | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')
            
            if [ -n "$ALL_TESTS" ]; then
              echo "Running tests for changed test files and related specs..."
              npm test -- $ALL_TESTS
            else
              echo "No test files found, running all tests..."
              npm test
            fi
          else
            echo "No files changed, running all tests..."
            npm test
          fi

      - name: Run Jest tests with coverage
        if: always()
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Running tests with coverage for changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            # Get changed test files
            CHANGED_TESTS=$(echo "$CHANGED_FILES" | grep -E '^tests/.*\.(test|spec)\.ts$' || echo "")
            
            # Get changed source files (excluding test files)
            CHANGED_SOURCE=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.ts$' || echo "")
            
            # Collect all test files to run:
            # 1. Changed test files
            # 2. Related test files for changed source files
            ALL_TESTS="$CHANGED_TESTS"
            
            # Find related test files for changed source files
            if [ -n "$CHANGED_SOURCE" ]; then
              echo "Finding related test files for changed source files..."
              while IFS= read -r source_file; do
                [ -z "$source_file" ] && continue
                # Map src/**/*.ts to tests/**/*.test.ts or tests/**/*.spec.ts
                # Example: src/services/telegram_service.ts -> tests/**/services/telegram_service.test.ts
                # Get relative path from src/
                rel_path=$(echo "$source_file" | sed 's|^src/||' | sed 's|\.ts$||')
                
                # Check for test files in various test directories (unit, integration, etc.)
                # Try .test.ts first, then .spec.ts
                test_file=$(find tests -path "*/${rel_path}.test.ts" -type f 2>/dev/null | head -1)
                if [ -n "$test_file" ]; then
                  ALL_TESTS="${ALL_TESTS}${test_file} "
                else
                  spec_file=$(find tests -path "*/${rel_path}.spec.ts" -type f 2>/dev/null | head -1)
                  if [ -n "$spec_file" ]; then
                    ALL_TESTS="${ALL_TESTS}${spec_file} "
                  fi
                fi
              done <<< "$CHANGED_SOURCE"
            fi
            
            # Remove duplicates and empty entries
            ALL_TESTS=$(echo "$ALL_TESTS" | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')
            
            if [ -n "$ALL_TESTS" ]; then
              echo "Running tests with coverage for changed test files and related specs..."
              npm run test:coverage -- $ALL_TESTS
            else
              echo "No test files found, running all tests with coverage..."
              npm run test:coverage
            fi
          else
            echo "No files changed, running all tests with coverage..."
            npm run test:coverage
          fi

      - name: Build project
        run: npm run build
