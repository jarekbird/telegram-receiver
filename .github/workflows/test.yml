name: Run Automated Tests

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for diff comparison

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            CHANGED=$(git diff --name-only --diff-filter=ACMR $BASE_SHA..$HEAD_SHA | grep -E '\.(ts|js)$' || true)
          else
            # For pushes, compare against previous commit
            CHANGED=$(git diff --name-only --diff-filter=ACMR HEAD~1..HEAD | grep -E '\.(ts|js)$' || true)
          fi
          
          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changed files detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Changed files:"
            echo "$CHANGED" | while read file; do
              echo "  - $file"
            done
          fi

      - name: Run ESLint linter
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Linting changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            # Filter out test files (only lint source files, matching Rails pattern)
            SOURCE_FILES=$(echo "$CHANGED_FILES" | grep -v '^tests/' || echo "")
            if [ -n "$SOURCE_FILES" ]; then
              # Run ESLint on all changed source files at once
              echo "$SOURCE_FILES" | tr '\n' '\0' | xargs -0 npx eslint
            else
              echo "No source files changed, skipping ESLint"
            fi
          else
            echo "No files changed, linting all files..."
            npm run lint
          fi

      - name: Check Prettier formatting
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Checking formatting for changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            # Filter to TypeScript files only
            TS_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|js)$' || echo "")
            if [ -n "$TS_FILES" ]; then
              # Run Prettier check on changed TypeScript files
              echo "$TS_FILES" | tr '\n' '\0' | xargs -0 npx prettier --check
            else
              echo "No TypeScript files changed, skipping Prettier check"
            fi
          else
            echo "No files changed, checking formatting for all files..."
            npm run format:check
          fi

      - name: Run TypeScript type check
        run: npm run type-check

      - name: Run unit tests with changed file detection
        id: unit-tests
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Running unit tests for changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            # Get changed unit test files
            CHANGED_UNIT_TESTS=$(echo "$CHANGED_FILES" | grep -E '^tests/unit/.*\.(test|spec)\.(ts|js)$' || echo "")
            
            # Get changed source files (excluding test files)
            CHANGED_SOURCE=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.(ts|js)$' || echo "")
            
            # Collect unit test files to run:
            # 1. Changed unit test files
            # 2. Related unit test files for changed source files
            ALL_UNIT_TESTS="$CHANGED_UNIT_TESTS"
            
            # Find related unit test files for changed source files
            if [ -n "$CHANGED_SOURCE" ]; then
              echo "Finding related unit test files for changed source files..."
              while IFS= read -r source_file; do
                [ -z "$source_file" ] && continue
                # Map src/**/*.ts to tests/unit/**/*.test.ts
                # Example: src/services/telegramService.ts -> tests/unit/services/telegramService.test.ts
                # Remove src/ prefix and file extension
                base_name=$(echo "$source_file" | sed 's|^src/||' | sed 's|\.ts$||' | sed 's|\.js$||')
                
                # Check unit test file (.test.ts)
                unit_test="tests/unit/${base_name}.test.ts"
                if [ -f "$unit_test" ]; then
                  ALL_UNIT_TESTS="${ALL_UNIT_TESTS}${unit_test} "
                fi
                
                # Also check for .spec.ts files
                unit_spec="tests/unit/${base_name}.spec.ts"
                if [ -f "$unit_spec" ]; then
                  ALL_UNIT_TESTS="${ALL_UNIT_TESTS}${unit_spec} "
                fi
              done <<< "$CHANGED_SOURCE"
            fi
            
            # Remove duplicates and empty entries
            ALL_UNIT_TESTS=$(echo "$ALL_UNIT_TESTS" | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')
            
            if [ -n "$ALL_UNIT_TESTS" ]; then
              echo "Running unit tests for changed test files and related specs..."
              npm run test:unit -- $ALL_UNIT_TESTS
            else
              echo "No unit test files found, running all unit tests..."
              npm run test:unit
            fi
          else
            echo "No files changed, running all unit tests..."
            npm run test:unit
          fi
        env:
          NODE_ENV: test

      - name: Run integration tests with changed file detection
        id: integration-tests
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Running integration tests for changed files..."
            CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
            # Get changed integration test files
            CHANGED_INTEGRATION_TESTS=$(echo "$CHANGED_FILES" | grep -E '^tests/integration/.*\.(test|spec)\.(ts|js)$' || echo "")
            
            # Get changed source files (excluding test files)
            CHANGED_SOURCE=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.(ts|js)$' || echo "")
            
            # Collect integration test files to run:
            # 1. Changed integration test files
            # 2. Related integration test files for changed source files
            ALL_INTEGRATION_TESTS="$CHANGED_INTEGRATION_TESTS"
            
            # Find related integration test files for changed source files
            if [ -n "$CHANGED_SOURCE" ]; then
              echo "Finding related integration test files for changed source files..."
              while IFS= read -r source_file; do
                [ -z "$source_file" ] && continue
                # Map src/**/*.ts to tests/integration/**/*.test.ts
                # Example: src/services/telegramService.ts -> tests/integration/services/telegramService.test.ts
                # Remove src/ prefix and file extension
                base_name=$(echo "$source_file" | sed 's|^src/||' | sed 's|\.ts$||' | sed 's|\.js$||')
                
                # Check integration test file (.test.ts)
                integration_test="tests/integration/${base_name}.test.ts"
                if [ -f "$integration_test" ]; then
                  ALL_INTEGRATION_TESTS="${ALL_INTEGRATION_TESTS}${integration_test} "
                fi
                
                # Also check for .spec.ts files
                integration_spec="tests/integration/${base_name}.spec.ts"
                if [ -f "$integration_spec" ]; then
                  ALL_INTEGRATION_TESTS="${ALL_INTEGRATION_TESTS}${integration_spec} "
                fi
              done <<< "$CHANGED_SOURCE"
            fi
            
            # Remove duplicates and empty entries
            ALL_INTEGRATION_TESTS=$(echo "$ALL_INTEGRATION_TESTS" | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')
            
            if [ -n "$ALL_INTEGRATION_TESTS" ]; then
              echo "Running integration tests for changed test files and related specs..."
              npm run test:integration -- $ALL_INTEGRATION_TESTS
            else
              echo "No integration test files found, running all integration tests..."
              npm run test:integration
            fi
          else
            echo "No files changed, running all integration tests..."
            npm run test:integration
          fi
        env:
          NODE_ENV: test
          REDIS_URL: redis://localhost:6379/0

      - name: Generate coverage report
        run: npm run test:coverage
        env:
          NODE_ENV: test
          REDIS_URL: redis://localhost:6379/0

      - name: Test result summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json | jq '.total' >> $GITHUB_STEP_SUMMARY || echo "Coverage summary not available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "coverage/lcov.info" ]; then
            echo "### Coverage Details" >> $GITHUB_STEP_SUMMARY
            echo "Coverage report generated successfully. See artifacts for full HTML report." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage/
          retention-days: 30
