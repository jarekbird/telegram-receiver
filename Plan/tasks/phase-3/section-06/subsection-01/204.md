# PHASE3-036: Review authentication/authorization

**Section**: 6. Security Review
**Subsection**: 6.1
**Task ID**: PHASE3-036

## Description

Review and improve authentication/authorization in the codebase to ensure best practices. This task focuses on validating that all authentication mechanisms are properly implemented, secure, and follow best practices.

## Authentication Mechanisms to Review

Based on the jarek-va Rails implementation, the following authentication mechanisms exist:

1. **Telegram Webhook Authentication** (`TelegramController#webhook`)
   - Header: `X-Telegram-Bot-Api-Secret-Token`
   - Secret: `telegram_webhook_secret` (from config)
   - Allows blank secret (development mode bypass)
   - Applied via `before_action :authenticate_webhook`

2. **Admin Authentication** (`TelegramController#set_webhook`, `#webhook_info`, `#delete_webhook`)
   - Header: `X-Admin-Secret` (or `HTTP_X_ADMIN_SECRET` env var)
   - Query/Body param: `admin_secret`
   - Secret: `webhook_secret` (from config)
   - Applied via `authenticate_admin` method

3. **Cursor-Runner Callback Authentication** (`CursorRunnerCallbackController#create`)
   - Headers: `X-Webhook-Secret` or `X-Cursor-Runner-Secret`
   - Query param: `secret`
   - Secret: `webhook_secret` (from config)
   - Allows blank secret (development mode bypass)
   - Applied via `before_action :authenticate_webhook`

4. **Agent Tools Authentication** (`AgentToolsController#create`)
   - Header: `X-EL-Secret`
   - Header: `Authorization: Bearer <token>` (token extracted from Bearer)
   - Secret: `webhook_secret` (from config)
   - Applied via `before_action :authenticate_webhook`

5. **Sidekiq Web UI** (mounted at `/sidekiq`)
   - Currently has no visible authentication protection
   - Comment in routes.rb mentions "protect in production" but no implementation found
   - **Note**: Sidekiq is Ruby-specific and won't be converted. If a Node.js equivalent (e.g., BullMQ dashboard) is implemented, it should be protected with authentication.

## Checklist

- [ ] Review Telegram webhook authentication (`X-Telegram-Bot-Api-Secret-Token` header validation)
- [ ] Review admin authentication (`X-Admin-Secret` header/param validation)
- [ ] Review cursor-runner callback authentication (`X-Webhook-Secret`/`X-Cursor-Runner-Secret` headers)
- [ ] Review agent tools authentication (`X-EL-Secret` header and `Authorization: Bearer` token)
- [ ] Review Sidekiq Web UI protection (currently unprotected)
- [ ] Check for authentication bypasses (development mode blank secret checks)
- [ ] Review secret token handling (header vs query param vs body param)
- [ ] Review secret configuration (default values, environment variable handling)
  - [ ] Verify default 'changeme' values are not used in production (require explicit configuration)
  - [ ] Verify environment variable precedence matches Rails (credentials → ENV → default)
  - [ ] Check that blank secrets are handled appropriately (development bypass vs production requirement)
- [ ] Check for proper authorization (role-based access, endpoint-specific permissions)
- [ ] Verify consistent secret naming and usage across endpoints
- [ ] Check for timing attack vulnerabilities in secret comparison
  - [ ] Verify Node.js implementation uses `crypto.timingSafeEqual()` instead of simple `==` comparison
  - [ ] Ensure all secret comparisons are constant-time (Rails uses vulnerable `==` comparison)
- [ ] Review error handling and logging (avoid leaking secret information)
  - [ ] Verify error messages are generic (e.g., "Unauthorized" not "Invalid secret")
  - [ ] Verify logs indicate secret presence (`[present]`/`[missing]`) but not actual secret values
  - [ ] Verify IP addresses are logged for security monitoring (as in Rails implementation)
- [ ] Identify security gaps (unprotected endpoints, weak secrets, etc.)
- [ ] Document authentication flow for each endpoint
- [ ] Review and document secret management best practices

## Rails Files to Review

Reference the following Rails files in jarek-va for authentication implementation:

- `app/controllers/telegram_controller.rb` - Telegram webhook and admin authentication
- `app/controllers/cursor_runner_callback_controller.rb` - Cursor-runner callback authentication
- `app/controllers/agent_tools_controller.rb` - Agent tools authentication
- `app/controllers/application_controller.rb` - Base controller (error handling)
- `config/routes.rb` - Route definitions and Sidekiq Web UI mounting
- `config/application.rb` - Secret configuration (webhook_secret, telegram_webhook_secret)
- `config/initializers/telegram.rb` - Telegram configuration initialization

## Security Concerns to Address

1. **Development Mode Bypasses**: Some authentication methods allow blank secrets in development mode. Review if this is appropriate or if stricter validation is needed.

2. **Default Secrets**:
   - Default secret values ('changeme') are used when secrets are not configured in Rails (`config/application.rb` lines 24-25, 44-45)
   - This is a security risk in production - verify Node.js implementation requires explicit secret configuration or fails securely
   - Check that environment variable handling matches Rails pattern (credentials first, then ENV, then default)

3. **Multiple Secret Sources**: Secrets can be passed via headers, query params, or body params. Review if this flexibility is necessary or if it creates security vulnerabilities.

4. **Inconsistent Secret Usage**: Different endpoints use different secret configurations (`webhook_secret` vs `telegram_webhook_secret`). Review if this is intentional or should be standardized.

5. **Unprotected Sidekiq Web UI**: The Sidekiq Web UI is mounted without authentication. This should be protected in production environments.

6. **Secret Comparison**:
   - Rails uses simple `==` comparison which is vulnerable to timing attacks
   - Node.js implementation should use `crypto.timingSafeEqual()` for constant-time comparison
   - Verify that all secret comparisons use timing-safe methods

7. **Error Messages**:
   - Ensure error messages don't leak information about secret validation failures
   - Rails logs warnings like "Unauthorized Telegram webhook request - invalid secret token" without exposing the actual secret
   - Verify Node.js implementation follows same pattern (generic error messages, no secret exposure)

8. **Logging**:
   - Review if authentication failures are logged appropriately without exposing sensitive information
   - Rails logs include IP addresses and secret presence status (`[present]` or `[missing]`) but not the actual secret value
   - Verify Node.js implementation logs authentication failures with similar detail level (no secret values)

## Notes

- This task is part of Phase 3: Holistic Review and Best Practices
- Section: 6. Security Review
- Focus on identifying issues and improvements
- Document findings and decisions
- Compare telegram-receiver implementation with jarek-va Rails implementation
- Ensure all authentication mechanisms are properly converted and secured

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE3-035
- Next: PHASE3-037

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

