# PHASE3-040: Review CORS and security headers

**Section**: 6. Security Review
**Subsection**: 6.5
**Task ID**: PHASE3-040

## Description

Review and improve CORS configuration and security headers in the codebase to ensure best practices. This task focuses on ensuring proper CORS policies are configured and essential security headers are set to protect the application from common web vulnerabilities.

## Rails Implementation Reference

The Rails application has minimal security header configuration:

1. **CORS Configuration** (`config/initializers/cors.rb`):
   - CORS is commented out (not configured)
   - Example configuration shows allowing specific origins with `Rack::Cors`
   - Default would allow all origins if uncommented (not secure)

2. **HTTPS Enforcement** (`config/environments/production.rb`):
   - `config.force_ssl = true` is commented out (not enforced)
   - This would enable HSTS (HTTP Strict Transport Security) if enabled

3. **Security Headers**:
   - No explicit security headers configured in Rails application code
   - Rails provides some default headers but not comprehensive security headers
   - Security headers are configured at the infrastructure level (Traefik reverse proxy in `docker-compose.yml`):
     - HSTS (Strict-Transport-Security) with 1-year max-age
     - SSL redirect enabled
     - Include subdomains and preload configured
   - This demonstrates that security headers can be handled at the reverse proxy level, but application-level headers provide defense in depth

## Checklist

### CORS Configuration Review

- [ ] Review current CORS implementation
  - [ ] Check if CORS middleware is installed (`cors` package)
  - [ ] Review CORS configuration in application setup
  - [ ] Verify CORS is configured with appropriate options (not allowing all origins)
  - [ ] Check if CORS is needed for this API (Telegram webhook receiver typically doesn't need CORS)
  - [ ] If CORS is not needed, verify it's disabled or not configured
  - [ ] If CORS is needed, verify it's restricted to specific origins
  - [ ] Check allowed methods (should be minimal: GET, POST, OPTIONS if needed)
  - [ ] Check allowed headers (should be minimal)
  - [ ] Verify credentials handling (if applicable)
  - [ ] Review CORS error handling

- [ ] CORS Best Practices
  - [ ] Verify CORS doesn't allow `*` origin in production
  - [ ] Check that CORS configuration is environment-specific (stricter in production)
  - [ ] Verify preflight OPTIONS requests are handled correctly
  - [ ] Check CORS headers are not exposed unnecessarily
  - [ ] Review CORS configuration for potential security issues

### Security Headers Review

- [ ] Review security headers middleware
  - [ ] Check if `helmet` package is installed (recommended Express security middleware)
  - [ ] Review current security headers configuration
  - [ ] Verify security headers are applied to all routes
  - [ ] Check middleware ordering (security headers should be early in middleware chain)

- [ ] Essential Security Headers
  - [ ] **X-Content-Type-Options**: Set to `nosniff` to prevent MIME type sniffing
  - [ ] **X-Frame-Options**: Set to `DENY` or `SAMEORIGIN` to prevent clickjacking
  - [ ] **X-XSS-Protection**: Set to `1; mode=block` (legacy but still useful)
  - [ ] **Strict-Transport-Security (HSTS)**: Configure for HTTPS enforcement
    - [ ] Set `max-age` (e.g., 31536000 for 1 year)
    - [ ] Include `includeSubDomains` if applicable
    - [ ] Include `preload` if applicable
  - [ ] **Content-Security-Policy (CSP)**: Configure if serving HTML (may not be needed for API-only)
  - [ ] **Referrer-Policy**: Set appropriate policy (e.g., `strict-origin-when-cross-origin`)
  - [ ] **Permissions-Policy**: Configure to restrict browser features (if applicable)

- [ ] HTTPS Enforcement
  - [ ] Review HTTPS enforcement mechanism
  - [ ] Check if application enforces HTTPS in production
  - [ ] Verify HSTS header is set correctly
  - [ ] Check for HTTP to HTTPS redirects (if applicable)
  - [ ] Review trust proxy configuration (needed behind reverse proxy)
  - [ ] Verify secure cookie settings (if cookies are used)

- [ ] Header Configuration Review
  - [ ] Check that security headers are set consistently across all routes
  - [ ] Verify headers are not overridden incorrectly
  - [ ] Review custom headers for security implications
  - [ ] Check for unnecessary headers that expose information
  - [ ] Verify server header is not exposing version information

### Security Header Implementation

- [ ] Review helmet.js usage (if implemented)
  - [ ] Check helmet configuration
  - [ ] Review which helmet features are enabled
  - [ ] Verify helmet is configured appropriately for API-only application
  - [ ] Check for any helmet features that should be disabled for API

- [ ] Review custom security headers (if any)
  - [ ] Check for custom security header middleware
  - [ ] Verify custom headers follow security best practices
  - [ ] Review header values for correctness

### Environment-Specific Configuration

- [ ] Review security configuration per environment
  - [ ] Check development environment configuration (may be more permissive)
  - [ ] Check production environment configuration (should be strict)
  - [ ] Verify test environment configuration (should not expose sensitive info)
  - [ ] Review environment variable usage for security settings

### Security Issues Identification

- [ ] Identify potential security vulnerabilities
  - [ ] Check for missing security headers
  - [ ] Check for overly permissive CORS configuration
  - [ ] Check for missing HTTPS enforcement
  - [ ] Check for information disclosure through headers
  - [ ] Review for common security misconfigurations

### Documentation

- [ ] Document security headers configuration
  - [ ] Document which security headers are configured
  - [ ] Document CORS configuration and rationale
  - [ ] Document HTTPS enforcement approach
  - [ ] Create or update security documentation
  - [ ] Document any security header decisions and trade-offs

### Implementation Recommendations

- [ ] Recommend security improvements
  - [ ] Recommend installing `helmet` if not already installed
  - [ ] Recommend specific security header configurations
  - [ ] Recommend CORS configuration improvements (if needed)
  - [ ] Recommend HTTPS enforcement improvements
  - [ ] Provide specific code examples for improvements

## Notes

- This task is part of Phase 3: Holistic Review and Best Practices
- Section: 6. Security Review
- Focus on identifying issues and improvements
- Document findings and decisions

- **Important**: For an API-only application (like telegram-receiver), CORS may not be needed if the API is only accessed server-to-server. However, if the API needs to be accessed from web browsers, proper CORS configuration is essential.

- **Security Headers**: The `helmet` package is the standard Express middleware for setting security headers. It provides sensible defaults but should be configured appropriately for the application's needs.

- **HTTPS Enforcement**: In production, HTTPS should be enforced. This can be done through:
  - Reverse proxy (nginx, Apache, Traefik) configuration
  - Application-level redirects
  - HSTS header configuration

- **Infrastructure vs Application-Level Security**: The Rails application uses Traefik reverse proxy to set security headers at the infrastructure level. While this is a valid approach, implementing security headers at the application level (using helmet.js) provides defense in depth and ensures headers are set even if the application is deployed without a reverse proxy. Consider both approaches:
  - Application-level headers (helmet.js): Provides defense in depth, works without reverse proxy
  - Infrastructure-level headers (reverse proxy): Can be more performant, centralized configuration
  - Best practice: Use both layers for maximum security

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE3-039
- Next: PHASE3-041

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

