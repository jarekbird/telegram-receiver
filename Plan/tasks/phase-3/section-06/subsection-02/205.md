# PHASE3-037: Review input validation

**Section**: 6. Security Review
**Subsection**: 6.2
**Task ID**: PHASE3-037

## Description

Review and improve input validation in the codebase to ensure best practices. This task focuses on validating that all API endpoints properly validate, sanitize, and type-check incoming request data to prevent security vulnerabilities and ensure data integrity.

## Rails Implementation Reference

The Rails application uses `params.permit()` for strong parameters and manual validation:

1. **TelegramController** (`app/controllers/telegram_controller.rb`):
   - `webhook`:
     - Receives JSON Telegram updates (no explicit permit, relies on JSON parsing)
     - Checks Content-Type header for `application/json` (uses `request.content_type&.include?('application/json')`)
     - Extracts update from `request.parameters` or `params`, removes controller/action/format/telegram keys
     - Authenticates via `authenticate_webhook` before_action (checks `X-Telegram-Bot-Api-Secret-Token` header)
   - `set_webhook`:
     - Receives `url` and `secret_token` params (no explicit permit)
     - Authenticates via `authenticate_admin` (checks `X-Admin-Secret` header or `admin_secret` param)
     - Uses default webhook URL if `url` param not provided
   - `webhook_info`: No params, requires admin authentication
   - `delete_webhook`: No params, requires admin authentication

2. **CursorRunnerCallbackController** (`app/controllers/cursor_runner_callback_controller.rb`):
   - `create`: Uses `params.permit()` with specific allowed fields:
     - `success`, `requestId`, `request_id`, `repository`, `branchName`, `branch_name`
     - `iterations`, `maxIterations`, `max_iterations`, `output`, `error`
     - `exitCode`, `exit_code`, `duration`, `timestamp`
   - Validates `request_id` is present (returns 400 if blank)
   - Normalizes camelCase/snake_case field names via `normalize_result()` method
   - Handles boolean conversion for `success` field (converts string "true"/"false", 1/0, true/false to boolean)
   - Sanitizes output by removing ANSI escape sequences via `clean_ansi_escape_sequences()` method
   - Truncates output to max length (3500 chars in debug mode, 4000 chars otherwise) before sending to Telegram
   - Authenticates via `authenticate_webhook` before_action (checks `X-Webhook-Secret` or `X-Cursor-Runner-Secret` header, or `secret` param)

3. **AgentToolsController** (`app/controllers/agent_tools_controller.rb`):
   - `create`: Receives tool requests
   - Uses `validate_request_params` before_action to check `params[:tool]` is present (returns 400 if missing)
   - Does NOT use `params.permit()` - directly accesses `params[:tool]`, `params[:args]`, `params[:conversation_id]`
   - Authenticates via `authenticate_webhook` before_action (checks `X-EL-Secret` header or `Authorization: Bearer <token>`)

## Checklist

### Request Body Validation

- [ ] Review Telegram webhook endpoint (`POST /telegram/webhook`)
  - [ ] Validate request body is valid JSON
  - [ ] Validate Content-Type header is `application/json` (or handle gracefully)
  - [ ] Validate Telegram update structure (message, edited_message, callback_query)
  - [ ] Check for required fields in update structure
  - [ ] Validate request body size limits (prevent DoS via large payloads)
  - [ ] Verify update data is sanitized before processing

- [ ] Review cursor-runner callback endpoint (`POST /cursor-runner/callback`)
  - [ ] Validate request body is valid JSON
  - [ ] Validate `request_id` is present and not blank (return 400 if missing)
  - [ ] Validate allowed fields only (equivalent to Rails `params.permit()`)
  - [ ] Validate field types (success: boolean, iterations: integer, etc.)
  - [ ] Validate string length limits for `output` and `error` fields
  - [ ] Handle both camelCase and snake_case field names (normalize)
  - [ ] Validate boolean conversion for `success` field (handle string "true"/"false")
  - [ ] Validate numeric fields (iterations, max_iterations, exit_code) are valid numbers
  - [ ] Check for request body size limits

- [ ] Review admin endpoints (`POST /telegram/set_webhook`, `GET /telegram/webhook_info`, `DELETE /telegram/webhook`)
  - [ ] Validate `url` parameter format (if provided in set_webhook)
  - [ ] Validate `secret_token` parameter (if provided in set_webhook)
  - [ ] Validate URL is valid format (not malicious)
  - [ ] Validate `admin_secret` parameter/header (checked in `authenticate_admin` but not explicitly permitted)
  - [ ] Check for parameter injection vulnerabilities

- [ ] Review agent tools endpoint (`POST /agent-tools`)
  - [ ] Validate request body structure
  - [ ] Validate `tool` parameter is present (Rails uses `validate_request_params` before_action)
  - [ ] Validate `args` parameter structure (if provided)
  - [ ] Validate `conversation_id` parameter format (if provided)
  - [ ] Consider using `params.permit()` equivalent to restrict allowed fields (Rails doesn't use permit here)
  - [ ] Validate authentication header (`X-EL-Secret` or `Authorization: Bearer <token>`)

### Input Sanitization

- [ ] Review all string inputs for sanitization
  - [ ] Sanitize `output` and `error` fields from cursor-runner callbacks
  - [ ] Remove ANSI escape sequences from output (as done in Rails `clean_ansi_escape_sequences()` method)
  - [ ] Remove carriage return/newline sequences (`\r\n` -> `\n`) and strip whitespace
  - [ ] Sanitize Telegram message text before processing (escape HTML entities when using HTML parse_mode)
  - [ ] Escape HTML entities in TelegramService when sending messages with HTML parse_mode (prevents Telegram parsing errors)
  - [ ] Validate and sanitize URLs in admin endpoints
  - [ ] Check for XSS vulnerabilities in user-controlled data
  - [ ] Truncate long outputs to prevent exceeding Telegram's 4096 character message limit

- [ ] Review file path handling
  - [ ] Validate file paths don't contain directory traversal (`../`)
  - [ ] Validate file paths are within allowed directories
  - [ ] Check for path injection vulnerabilities

### Type Validation

- [ ] Review type checking for all endpoints
  - [ ] Validate numeric fields are numbers (not strings) - `iterations`, `max_iterations`, `exit_code`, `duration`
  - [ ] Validate boolean fields are booleans (handle string conversions)
    - Rails `normalize_result()` handles: `true`, `'true'`, `1`, `'1'` -> `true`; `false`, `'false'`, `0`, `'0'`, `nil` -> `false`
  - [ ] Validate string fields are strings - `request_id`, `repository`, `branch_name`, `output`, `error`, `timestamp`
  - [ ] Validate array/object structures match expected types (Telegram update structure)
  - [ ] Use TypeScript types for compile-time validation
  - [ ] Add runtime type validation where needed (using validation library like Zod or Joi)
  - [ ] Handle default values for optional fields (e.g., `iterations` defaults to 0, `max_iterations` defaults to 25)

### Injection Vulnerabilities

- [ ] Check for SQL injection risks
  - [ ] Review any database queries (if applicable)
  - [ ] Verify parameterized queries are used
  - [ ] Check Redis key construction for injection risks

- [ ] Check for command injection risks
  - [ ] Review any shell command execution
  - [ ] Validate inputs before passing to shell commands
  - [ ] Use safe command execution methods

- [ ] Check for NoSQL injection risks
  - [ ] Review Redis operations for injection risks
  - [ ] Validate Redis key names

- [ ] Check for template injection risks
  - [ ] Review any template rendering (if applicable)
  - [ ] Validate template variables

### File Upload Validation (if applicable)

- [ ] Review file download/upload handling
  - [ ] Validate file types (if file uploads are added)
  - [ ] Validate file sizes
  - [ ] Validate file names
  - [ ] Check for malicious file content
  - [ ] Note: Current implementation downloads files from Telegram, doesn't accept uploads

### Request Size Limits

- [ ] Review Express body parser limits
  - [ ] Verify `express.json()` has appropriate `limit` option (Rails doesn't set explicit limits)
  - [ ] Verify `express.urlencoded()` has appropriate `limit` option (if used)
  - [ ] Set reasonable limits to prevent DoS attacks (e.g., 10MB for JSON, 1MB for URL-encoded)
  - [ ] Consider Telegram update size limits (Telegram API has its own limits)
  - [ ] Consider cursor-runner callback size limits (output/error fields can be large)
  - [ ] Document size limits in configuration
  - [ ] Handle 413 Payload Too Large errors gracefully

### Validation Gaps

- [ ] Identify endpoints missing validation
  - [ ] TelegramController `webhook` - no explicit permit, relies on JSON parsing
  - [ ] TelegramController `set_webhook` - no explicit permit for `url` and `secret_token`
  - [ ] AgentToolsController `create` - no explicit permit, only checks `tool` presence
- [ ] Identify fields missing type checking
  - [ ] `url` parameter in `set_webhook` - should validate URL format
  - [ ] `secret_token` parameter - should validate format/character restrictions
  - [ ] `args` parameter in agent tools - should validate structure if it's an object
  - [ ] `conversation_id` parameter - should validate format if it has a specific structure
- [ ] Identify missing sanitization steps
  - [ ] Telegram update data before processing (currently passed directly to job)
  - [ ] File paths when downloading from Telegram (check for directory traversal)
- [ ] Check for validation inconsistencies across endpoints
  - [ ] Some endpoints use `params.permit()`, others don't
  - [ ] Some endpoints validate required fields, others don't
  - [ ] Authentication patterns vary (header names, param names)
- [ ] Review error handling for validation failures
  - [ ] Ensure consistent error response format (400 Bad Request for validation errors)
  - [ ] Ensure error messages don't leak sensitive information

### Validation Strategy Documentation

- [ ] Document validation approach (validation library choice, if any)
- [ ] Document validation patterns used across endpoints
- [ ] Document field normalization strategies (camelCase/snake_case handling)
- [ ] Document error response format for validation failures
- [ ] Document request size limits
- [ ] Create or update validation guidelines
- [ ] Document any validation middleware patterns

### Implementation Recommendations

- [ ] Consider using validation library (Zod, Joi, or express-validator)
- [ ] Create reusable validation schemas/functions in `src/validators/` directory
- [ ] Implement validation middleware for common patterns
- [ ] Add TypeScript types for all request/response structures
- [ ] Ensure validation errors return appropriate HTTP status codes (400 Bad Request)

## Notes

- This task is part of Phase 3: Holistic Review and Best Practices
- Section: 6. Security Review
- Focus on identifying issues and improvements
- Document findings and decisions

- **Key Rails Validation Patterns to Replicate:**
  - `params.permit()` equivalent for whitelisting allowed fields
  - Boolean conversion handling (string "true"/"false" -> boolean)
  - camelCase/snake_case normalization
  - ANSI escape sequence removal from output
  - Output truncation to prevent exceeding Telegram limits
  - HTML entity escaping for Telegram messages

- **Current Rails Validation Gaps (to improve in Node.js version):**
  - TelegramController endpoints don't use `params.permit()`
  - AgentToolsController doesn't use `params.permit()`
  - No explicit URL format validation in `set_webhook`
  - No explicit request body size limits

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE3-036
- Next: PHASE3-038

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

