# PHASE3-045: Review test organization

**Section**: 7. Testing Review
**Subsection**: 7.2
**Task ID**: PHASE3-045

## Description

Review and improve test organization in the codebase to ensure best practices.

## Checklist

- [x] Review test file structure
- [x] Check test naming conventions
- [x] Review test grouping
- [x] Check for test duplication
- [x] Review test fixtures
- [x] Identify organizational improvements
- [x] Document test structure

## Review Findings

### Test File Structure ✅

**Current State:**

- Well-organized directory structure with clear separation:
  - `tests/unit/` - Unit tests mirroring src structure
  - `tests/integration/` - Integration tests for API and services
  - `tests/e2e/` - End-to-end tests using Playwright
  - `tests/fixtures/` - Reusable test data
  - `tests/mocks/` - Mock implementations
  - `tests/helpers/` - Test utility functions
  - `tests/setup.ts` - Jest configuration setup

**Assessment:** Structure follows best practices and properly separates concerns.

### Test Naming Conventions ✅

**Current State:**

- Jest config accepts both `.test.ts` and `.spec.ts` patterns (for flexibility)
- README clearly specifies naming convention:
  - Unit tests: Use `*.test.ts` suffix
  - Integration tests: Use `*.test.ts` suffix
  - E2E tests: Use `*.spec.ts` suffix (Playwright convention)
- Documentation explicitly states: "Standard: Jest-based tests (unit and integration) use `.test.ts`, Playwright E2E tests use `.spec.ts`"
- E2E README also confirms `.spec.ts` convention

**Assessment:** Naming convention is clearly documented and standardized. The Jest config accepts both patterns for flexibility, but the documentation provides clear guidance.

**Note:** No changes needed - convention is already well-established in documentation.

### Test Grouping ✅

**Current State:**

- Unit test directories mirror `src/` structure:
  - `controllers/`, `services/`, `routes/`, `middleware/`, `utils/`, `models/`, `config/`, `types/`
- Integration tests grouped by type: `api/`, `services/`
- Clear separation between test types

**Assessment:** Grouping is logical and maintainable. Structure properly mirrors source code organization.

### Test Duplication ✅

**Current State:**

- No actual test files exist yet (all test directories are empty)
- Cannot assess duplication at this time

**Assessment:** Structure prevents duplication through:

- Shared fixtures (`tests/fixtures/`)
- Reusable mocks (`tests/mocks/`)
- Helper utilities (`tests/helpers/`)

### Test Fixtures ✅

**Current State:**

- `fixtures/telegramMessages.ts` - Telegram message fixtures with factory function
- `fixtures/apiResponses.ts` - API response fixtures with factory function
- Good use of factory functions for customization

**Assessment:** Fixtures are well-structured and reusable. Factory pattern allows test-specific customization.

**Improvements Needed:**

- Consider adding more fixture types as needed (database seeds, user data, etc.)

### Test Mocks ✅

**Current State:**

- `mocks/telegramApi.ts` - Telegram API mocks with reset function
- `mocks/cursorRunnerApi.ts` - Cursor Runner API mocks with reset function
- `mocks/redis.ts` - Redis client mocks with reset function
- All mocks include reset functions for test isolation

**Assessment:** Mocks are well-implemented with proper reset mechanisms.

### Test Helpers ✅

**Current State:**

- `helpers/testUtils.ts` - General utilities (waitFor, createMockFn, randomString, etc.)
- `helpers/apiHelpers.ts` - API testing utilities (createTestRequest, HTTP_STATUS, headers)

**Assessment:** Helpers provide useful utilities for common test patterns.

**Improvements Needed:**

- Add database helpers (mentioned in README but not implemented)
- Consider adding more specialized helpers as patterns emerge

### Organizational Improvements Identified

1. **Test Coverage Configuration**
   - **Current**: No coverage thresholds defined in jest.config.ts
   - **Recommendation**: Add coverage thresholds to enforce minimum coverage
   - **Priority**: Medium
   - **Impact**: Ensures quality standards

2. **Missing Test Utilities**
   - **Current**: Database helpers mentioned in README but not implemented
   - **Recommendation**: Add database test helpers when database integration is needed
   - **Priority**: Low (deferred until needed)

3. **Test File Organization**
   - **Current**: Empty directories ready for tests
   - **Recommendation**: Add `.gitkeep` files or initial test examples to document structure
   - **Priority**: Low

4. **Documentation Updates**
   - **Current**: Good documentation but could clarify naming conventions
   - **Recommendation**: Update README to specify `.test.ts` for Jest, `.spec.ts` for Playwright
   - **Priority**: Medium

## Recommendations Summary

### High Priority

- None identified

### Medium Priority

1. **Add coverage thresholds**: Configure minimum coverage requirements in jest.config.ts
   - Current: No coverage thresholds defined
   - Recommendation: Add thresholds to enforce minimum coverage (e.g., statements: 80%, branches: 75%, functions: 80%, lines: 80%)

### Low Priority

1. Add database helpers when database integration is implemented
2. Consider adding example test files or `.gitkeep` files in empty directories

## Test Structure Documentation

### Directory Structure

```
tests/
├── unit/              # Unit tests (use .test.ts)
│   ├── controllers/  # Controller unit tests
│   ├── services/     # Service unit tests
│   ├── routes/       # Route handler unit tests
│   ├── middleware/   # Middleware unit tests
│   ├── utils/        # Utility function tests
│   ├── models/       # Model tests
│   ├── config/       # Configuration tests
│   └── types/        # Type definition tests
├── integration/      # Integration tests (use .test.ts)
│   ├── api/          # API endpoint integration tests
│   └── services/     # Service integration tests
├── e2e/              # End-to-end tests (use .spec.ts - Playwright)
├── fixtures/         # Test data fixtures
├── mocks/            # Mock implementations
├── helpers/          # Test helper utilities
└── setup.ts          # Jest setup file
```

### Naming Conventions

- **Unit/Integration Tests**: Use `.test.ts` suffix (e.g., `userService.test.ts`)
- **E2E Tests**: Use `.spec.ts` suffix (e.g., `userFlow.spec.ts`)
- **Test Files**: Mirror source file names when possible (e.g., `src/services/userService.ts` → `tests/unit/services/userService.test.ts`)

### Test Organization Best Practices

1. **One test file per source file** (when applicable)
2. **Group related tests** using `describe` blocks
3. **Use fixtures** for reusable test data
4. **Mock external dependencies** using mocks directory
5. **Keep tests independent** - no shared state between tests
6. **Follow AAA pattern**: Arrange, Act, Assert

## Notes

- This task is part of Phase 3: Holistic Review and Best Practices
- Section: 7. Testing Review
- Review completed: Test structure is well-organized with minor improvements recommended
- All test directories are currently empty (no actual test files exist yet)
- Structure is ready for test implementation

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE3-044
- Next: PHASE3-046

---

IMPORTANT: When updating system settings (SystemSetting model), you MUST use the cursor-runner-shared-sqlite MCP connection.

IMPORTANT: When working with tasks (creating, querying, updating, or deleting tasks), you MUST use the cursor-runner-shared-sqlite MCP connection. The tasks table is in the shared SQLite database at /app/shared_db/shared.sqlite3.

Tasks Table Schema:

- id: INTEGER PRIMARY KEY AUTOINCREMENT
- prompt: TEXT NOT NULL (the task prompt/description to be executed)
- status: INTEGER NOT NULL DEFAULT 0 (task status enum: 0=ready, 1=complete, 2=archived, 3=backlogged)
- createdat: DATETIME DEFAULT CURRENT_TIMESTAMP
- updatedat: DATETIME DEFAULT CURRENT_TIMESTAMP
- order: INTEGER DEFAULT 0 (lower numbers are processed first)
- uuid: TEXT (unique identifier, indexed)

Task Status Values:

- 0 = ready (ready to be processed by task operator)
- 1 = complete (task has been completed)
- 2 = archived (task has been archived)
- 3 = backlogged (task is in backlog, not ready for processing)

Task Management Examples:

- To create a ready task: INSERT INTO tasks (prompt, "order", status) VALUES ('your prompt here', 0, 0)
- To list ready tasks: SELECT \* FROM tasks WHERE status = 0 ORDER BY "order" ASC, id ASC
- To mark a task as complete: UPDATE tasks SET status = 1, updatedat = CURRENT_TIMESTAMP WHERE id = ?
- To archive a task: UPDATE tasks SET status = 2, updatedat = CURRENT_TIMESTAMP WHERE id = ?
- To backlog a task: UPDATE tasks SET status = 3, updatedat = CURRENT_TIMESTAMP WHERE id = ?
- To get next ready task: SELECT \* FROM tasks WHERE status = 0 ORDER BY "order" ASC, id ASC LIMIT 1

The task operator agent (when enabled) automatically processes tasks with status = 0 (ready), sending the prompt to cursor-runner for execution.

IMPORTANT: When working with cursor-agents (creating, listing, getting status, or deleting agents), use the Python scripts in /cursor/tools/cursor-agents/ directory. These scripts communicate with the cursor-agents service over HTTP:

Agent Management:

- To list all agents: python3 /cursor/tools/cursor-agents/list_agents.py
- To get agent status: python3 /cursor/tools/cursor-agents/get_agent_status.py --name <agent-name>
- To create an agent: python3 /cursor/tools/cursor-agents/create_agent.py --name <name> --target-url <url> [options]
  - Use --queue <queue-name> to assign the agent to a specific queue (defaults to "default" if not specified)
  - Use --schedule <cron-pattern> for recurring agents (e.g., "0 8 \* \* \*" for daily at 8 AM)
  - Use --one-time for one-time agents that run immediately
- To delete an agent: python3 /cursor/tools/cursor-agents/delete_agent.py --name <agent-name>

Queue Management:

- To list all queues: python3 /cursor/tools/cursor-agents/list_queues.py
- To get queue info: python3 /cursor/tools/cursor-agents/get_queue_info.py --queue-name <queue-name>
- To delete an empty queue: python3 /cursor/tools/cursor-agents/delete_queue.py --queue-name <queue-name>
  - Note: Cannot delete the "default" queue or queues with active jobs

Task Operator Management:

- To enable the task operator: python3 /cursor/tools/cursor-agents/enable_task_operator.py [--queue <queue-name>]
  - The task operator automatically processes tasks from the tasks table in the database
  - It checks for incomplete tasks (lowest order first) and sends them to cursor-runner
  - Automatically re-enqueues itself every 5 seconds while enabled
- To disable the task operator: python3 /cursor/tools/cursor-agents/disable_task_operator.py
  - Sets the task_operator system setting to false, stopping re-enqueueing

When creating an agent, the target URL should be the cursor-runner docker networked URL (http://cursor-runner:3001/cursor/iterate/async) with a prompt that this agent will later execute.

Queue Organization: Agents can be organized into queues to avoid queue bloat. By default, agents are created in the "default" queue. Use descriptive queue names like "daily-tasks", "hourly-sync", or "urgent-jobs" to group related agents together.

IMPORTANT: When creating one-time scripts (shell scripts, Python scripts, etc.), place them in /cursor/scripts. This directory is shared and persistent across container restarts. Do not create scripts in the repository directories or other temporary locations.
