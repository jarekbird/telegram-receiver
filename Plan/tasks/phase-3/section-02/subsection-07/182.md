# PHASE3-014: Add missing type annotations

**Section**: 2. TypeScript Best Practices
**Subsection**: 2.7
**Task ID**: PHASE3-014

## Description

Review and add missing type annotations throughout the codebase to ensure TypeScript best practices are followed. This task focuses on identifying functions, objects, and exports that lack explicit type annotations and adding them where they improve code clarity, type safety, and developer experience.

## Files Requiring Type Annotation Review

Based on codebase review, the following files need type annotation improvements:

1. **Test Mocks** (`tests/mocks/`):
   - `tests/mocks/telegramApi.ts` - Missing return type `void` for `resetTelegramApiMocks()`, missing type definitions for `mockTelegramApi` object (should define interface/type for Telegram API mock with methods like `sendMessage`, `getUpdates`, `setWebhook`, `deleteWebhook`, `getMe` that return Jest mock functions)
   - `tests/mocks/cursorRunnerApi.ts` - Missing return type `void` for `resetCursorRunnerApiMocks()`, missing type definitions for `mockCursorRunnerApi` object (should define interface/type for Cursor Runner API mock with methods like `sendMessage`, `iterate`, `iterateAsync` that return Jest mock functions)
   - `tests/mocks/redis.ts` - Missing return type `void` for `resetRedisMocks()`, missing type definitions for `mockRedisClient` object (should define interface/type for Redis mock client with methods like `get`, `set`, `del`, `exists`, `expire`, `keys`, `hget`, `hset`, `hdel`, `hgetall`, `ping`, `quit` that return Jest mock functions)

2. **Test Fixtures** (`tests/fixtures/`):
   - `tests/fixtures/apiResponses.ts` - Missing return type for `createCursorRunnerResponse()` function (should return a type based on `cursorRunnerSuccessResponse`), missing type definitions for `cursorRunnerSuccessResponse` and `cursorRunnerErrorResponse` objects (should create interfaces/types for success and error response structures)
   - `tests/fixtures/telegramMessages.ts` - Missing return type for `createTelegramMessage()` function (should return a Telegram Update type), missing type definitions for `sampleTextMessage`, `sampleCallbackQuery`, and `sampleWebhookUpdate` objects (should create interfaces/types matching Telegram Bot API Update structure)

3. **Test Helpers** (`tests/helpers/`):
   - `tests/helpers/testUtils.ts` - Already reviewed in PHASE3-013, verify all type annotations are complete (currently has proper return types and parameter types)
   - `tests/helpers/apiHelpers.ts` - Review for any missing type annotations (currently has proper types, but verify `createAuthHeaders()` and `createJsonHeaders()` return types are explicit if needed)

4. **Configuration Files**:
   - `playwright.config.ts` - Verify all configuration options are properly typed
   - `jest.config.ts` - Verify configuration is properly typed (already uses `Config` type)

5. **Source Files** (`src/`):
   - `src/index.ts` - Currently empty, but when implemented, ensure all exports are properly typed

## Checklist

### 1. Review Function Return Types

- [ ] Review all functions in test mocks and add explicit return types where missing
- [ ] Review all helper functions and add explicit return types
- [ ] Review all fixture factory functions and add explicit return types
- [ ] Ensure functions that return `void` are explicitly annotated
- [ ] Ensure async functions have proper `Promise<T>` return types

### 2. Review Function Parameter Types

- [ ] Verify all function parameters have explicit types
- [ ] Review optional parameters and ensure they're properly typed
- [ ] Check for `any` types in function parameters and replace with proper types
  - Pay special attention to `createCursorRunnerResponse(overrides = {})` and `createTelegramMessage(overrides = {})` - the `overrides` parameter should be typed (e.g., `Partial<CursorRunnerResponse>`)
- [ ] Ensure default parameter values are compatible with their types
- [ ] Check for implicit `any` types that may arise from untyped object literals

### 3. Add Type Definitions for Objects

- [ ] Create type definitions for Telegram API mock objects (`tests/mocks/telegramApi.ts`)
  - Define interface/type for `mockTelegramApi` with typed Jest mock functions for each method
  - Use `jest.MockedFunction` or similar Jest types for mock function properties
- [ ] Create type definitions for Cursor Runner API mock objects (`tests/mocks/cursorRunnerApi.ts`)
  - Define interface/type for `mockCursorRunnerApi` with typed Jest mock functions
  - Ensure mock return values match expected API response structures
- [ ] Create type definitions for Redis mock client (`tests/mocks/redis.ts`)
  - Define interface/type for `mockRedisClient` with typed Jest mock functions
  - Match Redis client method signatures (e.g., `get(key: string): Promise<string | null>`)
- [ ] Create type definitions for API response fixtures (`tests/fixtures/apiResponses.ts`)
  - Create interfaces for `CursorRunnerSuccessResponse` and `CursorRunnerErrorResponse`
  - Type the return value of `createCursorRunnerResponse()` function
- [ ] Create type definitions for Telegram message fixtures (`tests/fixtures/telegramMessages.ts`)
  - Create interfaces/types matching Telegram Bot API Update structure
  - Type the return value of `createTelegramMessage()` function
  - Consider using or referencing official Telegram Bot API types if available

### 4. Review Exported Types and Interfaces

- [ ] Ensure all exported types and interfaces are properly documented
- [ ] Verify exported types match their actual usage
- [ ] Check for missing type exports that should be public

### 5. Add JSDoc Type Annotations

- [ ] Add JSDoc comments with `@param` and `@returns` tags where helpful
- [ ] Add JSDoc `@type` annotations for complex types where TypeScript types might not be sufficient
- [ ] Ensure JSDoc comments match TypeScript type annotations

### 6. Verify Public APIs Are Typed

- [ ] Review all exported functions and ensure they have proper type annotations
- [ ] Review all exported constants and ensure they have proper types
- [ ] Review all exported objects and ensure they have type definitions

### 7. Type Annotation Strategy Documentation

- [ ] Document when explicit return types are required vs when inference is preferred
- [ ] Document type annotation patterns used in the codebase
- [ ] Create or update `docs/typescript-patterns.md` with type annotation guidelines

### 8. Verification

- [ ] Run `npm run type-check` and verify no type errors
- [ ] Run `npm run lint` and verify no type-related warnings
- [ ] Run `npm test` to ensure all tests still pass after adding type annotations
- [ ] Verify TypeScript compiler strict mode compliance

## Notes

- This task is part of Phase 3: Holistic Review and Best Practices
- Section: 2. TypeScript Best Practices
- Focus on identifying issues and improvements
- Document findings and decisions

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE3-013
- Next: PHASE3-015

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

