# PHASE1-044: Create test setup file

**Section**: 10. Test Suite Setup
**Subsection**: 10.3
**Task ID**: PHASE1-044

## Description

Create and enhance the test setup file (`tests/setup.ts`) for the TypeScript/Node.js application. This file replaces the Rails test setup files (`spec/spec_helper.rb` and `spec/rails_helper.rb`) and provides global test configuration, setup hooks, and cleanup hooks that run before and after all tests.

The setup file should:

- Set the test environment variable
- Configure Jest timeout settings
- Provide global setup hooks (`beforeAll`) for initializing test infrastructure
- Provide global cleanup hooks (`afterAll`) for cleaning up after all tests complete
- Set up any global mocks or test utilities needed across all tests

**Rails Equivalent**: This task converts the functionality from `spec/spec_helper.rb` and `spec/rails_helper.rb` in the jarek-va Rails application. The Rails helpers:

- Set `ENV['RAILS_ENV'] = 'test'` (in `rails_helper.rb`)
- Load the Rails environment and RSpec Rails
- Include FactoryBot methods for test data creation
- Load support files (including `spec/support/sidekiq.rb` which clears ActiveJob queues before each test)
- Configure transactional fixtures for database tests
- Check for pending migrations before running tests

Note: `spec_helper.rb` contains basic RSpec configuration (expectations, mocks) but does not set the test environment variable. The environment variable is set in `rails_helper.rb`, which also requires `spec_helper.rb`.

## Checklist

- [ ] Open `tests/setup.ts` file (file already exists, needs enhancement)
- [ ] Ensure `process.env.NODE_ENV` is set to 'test' (already present, verify)
- [ ] Ensure `jest.setTimeout(10000)` is configured (already present, verify)
- [ ] Add `beforeAll` hook for global test setup
  - [ ] Clear/reset any global mocks (Redis, Telegram API, Cursor Runner API)
  - [ ] Set up test environment variables if needed
  - [ ] Initialize any test infrastructure (e.g., test database connections, Redis connections)
- [ ] Add `afterAll` hook for global test cleanup
  - [ ] Clean up any resources created during tests
  - [ ] Close connections (database, Redis, etc.)
  - [ ] Verify no test leaks or hanging promises
- [ ] Add `beforeEach` hook for per-test setup (optional, but recommended)
  - [ ] Clear mocks before each test to ensure test isolation
  - [ ] Reset Redis mocks using `resetRedisMocks()` from `tests/mocks/redis.ts`
  - [ ] Reset Telegram API mocks using `resetTelegramApiMocks()` from `tests/mocks/telegramApi.ts`
  - [ ] Reset Cursor Runner API mocks using `resetCursorRunnerApiMocks()` from `tests/mocks/cursorRunnerApi.ts`
- [ ] Add `afterEach` hook for per-test cleanup (optional, but recommended)
  - [ ] Clear any test-specific state
  - [ ] Ensure no async operations are left hanging
- [ ] Add JSDoc comments explaining the purpose of each hook
- [ ] Export any test utilities if needed (or reference existing utilities in `tests/helpers/testUtils.ts`)

## Notes

- This task is part of Phase 1: Basic Node.js API Infrastructure
- Section: 10. Test Suite Setup
- Task can be completed independently by a single agent
- The `tests/setup.ts` file already exists with basic configuration and needs to be enhanced with setup/cleanup hooks
- This file is automatically loaded by Jest via `setupFilesAfterEnv` configuration in `jest.config.ts` (configured in PHASE1-043)
- The setup file runs before each test file, similar to how `rails_helper.rb` runs before each RSpec test file
- Unlike Rails which uses `before` blocks in `spec/support/sidekiq.rb` to clear queues, Jest uses `beforeEach` hooks for per-test setup
- Mock reset functions are available in `tests/mocks/redis.ts`, `tests/mocks/telegramApi.ts`, and `tests/mocks/cursorRunnerApi.ts` and should be used in `beforeEach` hooks
- Test utilities are available in `tests/helpers/testUtils.ts` and don't need to be re-exported from setup.ts

## Related Tasks

- Previous: PHASE1-043
- Next: PHASE1-045

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

