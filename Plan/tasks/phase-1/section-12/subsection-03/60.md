# PHASE1-060: Document API conventions

**Section**: 12. API Structure Documentation
**Subsection**: 12.3
**Task ID**: PHASE1-060

## Description

Document API conventions based on the jarek-va Rails application patterns. This documentation will guide developers in maintaining consistency when implementing the Node.js/Express API conversion. The conventions should reflect the patterns found in the Rails codebase while adapting them appropriately for Node.js/Express.

## Checklist

- [ ] Create `docs/API_CONVENTIONS.md` file
- [ ] Document route naming conventions:
  - [ ] RESTful route patterns (GET, POST, DELETE, etc.)
  - [ ] Route scoping and namespacing (e.g., `/cursor-runner/*`, `/telegram/*`)
  - [ ] snake_case for route paths
  - [ ] Route organization patterns
- [ ] Document controller naming conventions:
  - [ ] Controller suffix pattern (e.g., `*Controller`)
  - [ ] Controller inheritance from base controller
  - [ ] Controller method naming (REST actions: show, create, etc.)
  - [ ] Controller organization and file structure
- [ ] Document service naming conventions:
  - [ ] Service suffix pattern (e.g., `*Service`)
  - [ ] Service class organization
  - [ ] Service method naming patterns
  - [ ] Service location and structure
- [ ] Document middleware naming conventions:
  - [ ] Express middleware naming patterns (equivalent to Rails `before_action` filters)
  - [ ] Authentication middleware patterns (e.g., `authenticateWebhook`, `authenticateAdmin`)
  - [ ] Validation middleware patterns
  - [ ] Middleware organization and structure
- [ ] Document error handling conventions:
  - [ ] Global error handler pattern (equivalent to `ApplicationController#handle_error`)
  - [ ] Error response format: `{ ok: false, say: '...', result: { error: ... } }`
  - [ ] HTTP status code conventions:
    - [ ] `500` for internal server errors (unhandled exceptions)
    - [ ] `502` for bad gateway (external service errors, e.g., CursorRunnerService errors)
    - [ ] `422` for unprocessable entity (service-level validation failures)
    - [ ] `401` for unauthorized (authentication failures)
    - [ ] `400` for bad request (validation errors, missing required parameters)
    - [ ] `200` for successful operations
  - [ ] Specific error type handling (e.g., service-specific errors)
  - [ ] Error logging patterns
- [ ] Document response format conventions:
  - [ ] Success response format variations:
    - [ ] `{ ok: true, ... }` - Standard success format (TelegramController, AgentToolsController)
    - [ ] `{ success: true, ... }` - Service response format (CursorRunnerController)
    - [ ] `{ status: 'healthy', service: ..., version: ... }` - Health check format
    - [ ] `{ received: true, ... }` - Callback acknowledgment format
  - [ ] Error response format variations:
    - [ ] `{ ok: false, say: '...', result: { error: ... } }` - ApplicationController global error handler
    - [ ] `{ ok: false, error: '...' }` - Controller-level error responses
    - [ ] `{ success: false, error: '...' }` - Service-level error responses
    - [ ] `{ error: '...' }` - Simple error responses (unauthorized, bad request)
  - [ ] Simple acknowledgment responses (empty body with status code, e.g., `head :ok`)
  - [ ] Response status code selection guidelines
  - [ ] JSON response structure consistency
  - [ ] When to use each response format variation

## Notes

- This task is part of Phase 1: Basic Node.js API Infrastructure
- Section: 12. API Structure Documentation
- Task can be completed independently by a single agent
- Reference the jarek-va Rails application (`/cursor/repositories/jarek-va`) for actual implementation patterns:
  - Controllers: `app/controllers/*.rb`
  - Routes: `config/routes.rb`
  - Services: `app/services/*.rb`
  - Error handling: `app/controllers/application_controller.rb`
- Key Rails patterns to document and adapt for Node.js/Express:
  - Authentication via headers: `X-Admin-Secret`, `X-Telegram-Bot-Api-Secret-Token`, `X-Webhook-Secret`
  - Webhook authentication patterns
  - Admin authentication patterns
  - Request parameter handling (query params, body params, headers)
  - Response format consistency across endpoints
- Include examples from actual Rails endpoints to illustrate conventions
- Document both Rails patterns and their Node.js/Express equivalents

## Related Tasks

- Previous: PHASE1-059
- Next: PHASE1-061

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

