# PHASE1-029: Add environment validation

**Section**: 7. Environment Variables Management
**Subsection**: 7.7
**Task ID**: PHASE1-029

## Description

Create an environment validation module that validates required environment variables on application startup. This ensures the application fails fast with clear error messages if critical configuration is missing, preventing runtime errors later.

While the Rails application (`jarek-va/config/application.rb`) uses `ENV.fetch()` with default values and doesn't explicitly validate environment variables, this is a Node.js best practice that improves developer experience and prevents configuration-related runtime errors. The validation should check that required variables are present and have valid values before the server starts.

**Rails Equivalent**: The Rails application doesn't have explicit environment validation. Rails uses `ENV.fetch()` with defaults throughout `config/application.rb`, but doesn't validate required variables on startup. This task adds explicit validation as a Node.js best practice.

**Note**: At this stage (Phase 1), only basic environment variables are validated. Additional environment variables (like `TELEGRAM_BOT_TOKEN`, `CURSOR_RUNNER_URL`, etc.) will be added to validation in later tasks as those features are implemented. For now, we validate that `NODE_ENV` is set (or defaults to "development") and that `PORT` is a valid number if provided.

## Checklist

- [ ] Create `src/config/validateEnv.ts` file (using camelCase naming convention)
- [ ] Create `validateEnv(config)` function that accepts the config object as a parameter and validates it (not raw process.env)
- [ ] Validate `config.env` (NODE_ENV) is one of: "development", "test", "production" (defaulting is handled by environment.ts, validation only checks if set)
- [ ] Validate `config.port` (PORT) is a valid positive integer (defaulting is handled by environment.ts, validation only checks if provided)
- [ ] Throw descriptive error with missing/invalid variable names if validation fails
- [ ] Export `validateEnv` function as default export
- [ ] Add JSDoc comments documenting the validation function and its behavior
- [ ] Import config from `./config/environment` and `validateEnv` from `./config/validateEnv` in `src/index.ts`
- [ ] Call `validateEnv(config)` in `src/index.ts` after importing config but before importing/starting the server
- [ ] Ensure validation runs before any other application initialization (after config import)
- [ ] Add error handling to log validation errors clearly before process exit

## Notes

- This task is part of Phase 1: Basic Node.js API Infrastructure
- Section: 7. Environment Variables Management
- Task can be completed independently by a single agent
- **Rails Comparison**: The Rails application (`jarek-va/config/application.rb`) doesn't explicitly validate environment variables. It uses `ENV.fetch()` with defaults throughout, allowing the application to start even if variables are missing. This Node.js implementation adds explicit validation as a best practice to fail fast with clear error messages.
- **Validation Scope**: At this stage, only basic variables are validated (`NODE_ENV` and `PORT`). As more features are implemented in later phases, additional environment variables will be added to the validation function (e.g., `TELEGRAM_BOT_TOKEN`, `CURSOR_RUNNER_URL`, `REDIS_URL`, etc.).
- **Error Handling**: The validation function should throw an error with a descriptive message listing all missing or invalid variables. The error should be caught in `src/index.ts` and logged before the process exits with a non-zero exit code.
- **Validation Approach**: The validation function should validate the config object values from `src/config/environment.ts`, not raw `process.env` values. The environment config module (PHASE1-024) handles loading and defaulting values. The validation function ensures that the processed config values are valid.
- **NODE_ENV Validation**: The `config.env` value (which comes from `NODE_ENV`) should be validated to ensure it's one of the standard values: "development", "test", or "production". Defaulting to "development" is handled by the environment config module (PHASE1-024), so validation only needs to check that if `NODE_ENV` was set, it has a valid value.
- **PORT Validation**: The `config.port` value (which comes from `PORT`) should be validated as a positive integer. Defaulting to 3000 is handled by the environment config module (PHASE1-024), so validation only needs to check that if `PORT` was provided, it's a valid positive integer.
- **File Naming**: Use camelCase naming (`validateEnv.ts`) to match TypeScript/Node.js conventions, rather than kebab-case (`validate-env.ts`).
- **Dependencies**: This task assumes `src/config/environment.ts` exists (created in PHASE1-024) and `src/index.ts` exists (updated in PHASE1-028). The validation function accepts the config object as a parameter, and `src/index.ts` imports both the config and validateEnv, then calls `validateEnv(config)` to validate the loaded config values.
- **Validation Order**: In `src/index.ts`, the validation should be called after importing the config from `./config/environment` but before importing the Express app or starting the server. This ensures config is loaded and validated before any application code runs.

## Related Tasks

- Previous: PHASE1-028
- Next: PHASE1-030

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

