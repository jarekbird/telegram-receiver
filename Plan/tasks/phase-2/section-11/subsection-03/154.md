# PHASE2-091: Create telegram routes

**Section**: 11. Routes Configuration
**Subsection**: 11.3
**Task ID**: PHASE2-091

## Description

Convert telegram routes from Rails to TypeScript/Node.js. Reference `jarek-va/config/routes.rb` and `jarek-va/app/controllers/telegram_controller.rb`.

This task creates the Express route definitions for Telegram webhook endpoints. The routes should be scoped under `/telegram` path and include appropriate authentication middleware.

## Checklist

- [ ] Create `src/routes/telegram-routes.ts`
- [ ] Define POST /telegram/webhook route
  - Apply webhook authentication middleware (checks X-Telegram-Bot-Api-Secret-Token header)
  - Route should delegate to telegram controller webhook handler
- [ ] Define POST /telegram/set_webhook route
  - Apply admin authentication middleware (checks X-Admin-Secret header, HTTP_X_ADMIN_SECRET env var, admin_secret query/body params)
  - Route should delegate to telegram controller set_webhook handler
  - Handler accepts optional `url` and `secret_token` parameters (uses defaults if not provided)
- [ ] Define GET /telegram/webhook_info route
  - Apply admin authentication middleware (checks X-Admin-Secret header, HTTP_X_ADMIN_SECRET env var, admin_secret query/body params)
  - Route should delegate to telegram controller webhook_info handler
- [ ] Define DELETE /telegram/webhook route
  - Apply admin authentication middleware (checks X-Admin-Secret header, HTTP_X_ADMIN_SECRET env var, admin_secret query/body params)
  - Route should delegate to telegram controller delete_webhook handler
- [ ] Export router for use in main application

## Authentication Requirements

Based on `jarek-va/app/controllers/telegram_controller.rb`:

1. **Webhook Authentication** (for POST /telegram/webhook):
   - Checks `X-Telegram-Bot-Api-Secret-Token` header
   - Compares against `telegram_webhook_secret` configuration value
   - **Important**: If `telegram_webhook_secret` is blank/empty, authentication is bypassed and request is allowed
   - Returns 401 Unauthorized only if secret token doesn't match AND expected secret is not blank
   - Logs warning on unauthorized requests

2. **Admin Authentication** (for set_webhook, webhook_info, delete_webhook):
   - Checks in order: `X-Admin-Secret` header, `HTTP_X_ADMIN_SECRET` environment variable, `admin_secret` query parameter, `admin_secret` body parameter
   - Compares against `webhook_secret` configuration value
   - Returns 401 Unauthorized if secret doesn't match
   - Note: In test environment, logs authentication failures for debugging

## Implementation Notes

- Routes are scoped under `/telegram` path prefix (as defined in Rails routes.rb)
- Reference `jarek-va/app/controllers/telegram_controller.rb` for controller implementation details
- The webhook endpoint should return 200 OK immediately and process updates asynchronously
- Admin endpoints should return JSON responses with `ok` field and appropriate data/error fields
- Error handling should follow the pattern in ApplicationController:
  - Success responses: `{ ok: true, ... }` with appropriate data fields
  - Error responses: `{ ok: false, say: 'Sorry, I encountered an error processing your request.', result: { error: errorMessage } }` with 500 status
  - Admin endpoints (set_webhook, webhook_info, delete_webhook) use simpler format: `{ ok: false, error: errorMessage }` with 500 status
  - Webhook endpoint always returns 200 OK even on errors (to prevent Telegram retries), but may attempt to send error message to chat if chat info is available

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 11. Routes Configuration
- Reference the Rails implementation for behavior
- Controller implementation will be handled in a separate task
- Authentication middleware should be created/referenced as needed

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-090
- Next: PHASE2-092

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

