# PHASE2-092: Create cursor-runner callback routes

**Section**: 11. Routes Configuration
**Subsection**: 11.4
**Task ID**: PHASE2-092

## Description

Add cursor-runner callback route to the existing cursor-runner routes file, converting from Rails to TypeScript/Node.js. Reference `jarek-va/config/routes.rb` and `jarek-va/app/controllers/cursor_runner_callback_controller.rb`.

This task adds the Express route definition for the cursor-runner callback webhook endpoint to the existing `src/routes/cursor-runner.routes.ts` file (created in PHASE2-089). The route should be scoped under `/cursor-runner` path and include appropriate webhook authentication middleware.

## Rails Implementation Reference

From `jarek-va/config/routes.rb`:

```ruby
scope path: 'cursor-runner', as: 'cursor_runner' do
  # Webhook callback endpoint (receives callbacks from cursor-runner)
  post 'callback', to: 'cursor_runner_callback#create'
end
```

From `jarek-va/app/controllers/cursor_runner_callback_controller.rb`:

- The controller uses `before_action :authenticate_webhook` for authentication
- The `create` method handles POST requests to `/cursor-runner/callback`
- Receives callback data from cursor-runner when iterate operation completes
- Processes callbacks synchronously and sends responses to Telegram

## Checklist

- [ ] Open existing `src/routes/cursor-runner.routes.ts` file (created in PHASE2-089)
- [ ] Import CursorRunnerCallbackController from `../controllers/cursor-runner-callback.controller` (if not already imported)
- [ ] Instantiate CursorRunnerCallbackController (if not already instantiated)
- [ ] Add POST `/callback` route to the existing router (will be mounted under `/cursor-runner` prefix)
  - Apply webhook authentication middleware (checks X-Webhook-Secret or X-Cursor-Runner-Secret headers, or secret query param)
  - Route should delegate to cursor-runner-callback controller create handler
- [ ] Ensure router is exported for use in main application (should already be exported)
- [ ] Use proper TypeScript types (Express Request/Response)
- [ ] Bind controller methods properly (use `.bind(controller)` or arrow functions)

## Authentication Requirements

Based on `jarek-va/app/controllers/cursor_runner_callback_controller.rb`:

**Webhook Authentication** (for POST /cursor-runner/callback):

- Checks `X-Webhook-Secret` header OR `X-Cursor-Runner-Secret` header OR `secret` query/body param
- Compares against `webhook_secret` configuration value (from `Rails.application.config.webhook_secret`)
- Allows request if secret matches OR if expected secret is blank (development mode)
- Returns 401 Unauthorized if secret is provided but doesn't match
- Logs warning for unauthorized attempts with IP address

## Implementation Notes

- This task adds the callback route to the existing `src/routes/cursor-runner.routes.ts` file created in PHASE2-089
- Routes are scoped under `/cursor-runner` path prefix (as defined in Rails routes.rb)
- The route file defines `/callback` which will be mounted as `/cursor-runner/callback` in the main application
- Reference `jarek-va/app/controllers/cursor_runner_callback_controller.rb` for controller implementation details
- The callback endpoint should return 200 OK immediately (even on errors) to prevent cursor-runner from retrying
- Error handling should follow the pattern in ApplicationController (returns JSON with error message)
- Authentication middleware should allow requests when webhook_secret is not configured (development mode)
- Controller implementation will be handled in a separate task
- The file `src/routes/cursor-runner.routes.ts` should already exist from PHASE2-089; this task adds the callback route to it

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 11. Routes Configuration
- Subsection: 11.4
- The file `src/routes/cursor-runner.routes.ts` should already exist from PHASE2-089; this task adds the callback route to it
- Reference the Rails implementation for behavior
- Controller implementation will be handled in a separate task
- Authentication middleware should be created/referenced as needed
- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-091
- Next: PHASE2-093

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

