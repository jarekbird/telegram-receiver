# PHASE2-101: Create controller test fixtures

**Section**: 13. Testing
**Subsection**: 13.2
**Task ID**: PHASE2-101

## Description

Create comprehensive API response fixtures for controller tests. These fixtures should match the response structures returned by external APIs (Telegram Bot API, Cursor Runner API, ElevenLabs API) as used in the Rails application. The fixtures will be used to mock external API responses in controller tests when testing services that call these APIs.

**Rails References**:

- `jarek-va/spec/services/telegram_service_spec.rb` - Telegram Bot API response structures (lines 42, 224, 269, 307-313)
- `jarek-va/spec/controllers/telegram_controller_spec.rb` - Telegram API usage in controller tests
- `jarek-va/spec/controllers/cursor_runner_controller_spec.rb` - Cursor Runner API response structures (lines 20-28, 73-82, 124-129, 155-160, 190-194, 226-230, 251-255)
- `jarek-va/spec/controllers/cursor_runner_callback_controller_spec.rb` - Callback response structures (lines 17-24, 115-120)
- `jarek-va/app/services/eleven_labs_speech_to_text_service.rb` - ElevenLabs STT response parsing (lines 57, 133-134)
- `jarek-va/app/services/eleven_labs_text_to_speech_service.rb` - ElevenLabs TTS response handling (lines 140-156)

## Checklist

- [ ] Update `tests/fixtures/apiResponses.ts` (file already exists, needs expansion)
- [ ] Create Telegram Bot API response fixtures:
  - [ ] `sendMessage` response: `{ ok: true, result: { message_id: number, date: number, text: string, chat: { id: number, type: string }, from: { id: number, ... } } }`
  - [ ] `setWebhook` response: `{ ok: true, result: true, description: string }`
  - [ ] `deleteWebhook` response: `{ ok: true, result: true, description: string }`
  - [ ] `getWebhookInfo` (webhookInfo) response: `{ ok: true, result: { url: string, pending_update_count: number, ... } }`
  - [ ] Error responses: `{ ok: false, description: string, error_code?: number }`
- [ ] Create Cursor Runner API response fixtures:
  - [ ] `execute` response: `{ success: true, requestId: string, repository: string, branchName: string, output: string, exitCode: number }`
  - [ ] `iterate` response: `{ success: true, requestId: string, repository: string, branchName: string, iterations: number, output: string, exitCode: number }`
  - [ ] `clone` response: `{ success: true, repository: string, message: string }`
  - [ ] `checkout` response: `{ success: true, message: string }`
  - [ ] `push` response: `{ success: true, message: string }`
  - [ ] `pull` response: `{ success: true, message: string }`
  - [ ] `repositories` response: `{ success: true, repositories: string[], count: number }`
  - [ ] Callback success response: `{ success: true, requestId: string, iterations: number, output: string, duration: string }`
  - [ ] Callback error response: `{ success: false, requestId: string, error: string }`
  - [ ] Error responses: `{ success: false, error: string }`
- [ ] Create ElevenLabs API response fixtures:
  - [ ] Speech-to-text success: `{ text: string }`
  - [ ] Speech-to-text error: `{ detail: string }` or `{ error: string }` or array format
  - [ ] Text-to-speech: Note that TTS returns binary audio data (Buffer), not JSON
- [ ] Add helper functions to create custom responses with overrides
- [ ] Export all fixtures properly

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 13. Testing
- The file `tests/fixtures/apiResponses.ts` already exists but is minimal - it needs to be expanded with comprehensive fixtures
- Reference the Rails service specs (`telegram_service_spec.rb`) and controller specs to understand exact response structures
- Fixtures should match the actual external API response formats (what services receive from Telegram, Cursor Runner, ElevenLabs APIs)
- These are NOT controller response formats - they are the raw API responses that services parse
- Include both success and error response variants
- Helper functions should allow easy customization of fixtures for specific test cases (similar to `createTelegramMessage` pattern in `telegramMessages.ts`)
- For Telegram API, the `result` object in success responses contains the actual data (message object, webhook info, etc.)
- For Cursor Runner API, responses use camelCase keys (e.g., `requestId`, `branchName`, `exitCode`)
- For ElevenLabs TTS, note that it returns binary audio data (Buffer/ArrayBuffer), not JSON - fixtures should represent this appropriately

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-100
- Next: PHASE2-102

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

