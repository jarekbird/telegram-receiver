# PHASE2-017: Test async processing system

**Section**: 3. Async Processing Setup
**Subsection**: 3.6
**Task ID**: PHASE2-017

## Description

Create comprehensive tests for the async processing system, converting the queue system tests from Rails Sidekiq to TypeScript/Node.js. This includes testing async configuration, async operations, retry behavior, error handling, and async utilities.

**Rails Implementation Reference:**

- `jarek-va/spec/config/sidekiq_spec.rb` - Sidekiq configuration tests:
  - Tests Sidekiq module loading and configuration methods (lines 6-12)
  - Tests default job options (retry: 3, backtrace: true) (lines 14-22)
  - Tests Redis URL configuration from environment (lines 24-30)
  - Tests Sidekiq YAML configuration file existence and environment-specific settings (lines 53-68)
  - Note: ActiveJob adapter configuration tests (lines 33-50) are not applicable - we use native async, not an adapter
- `jarek-va/spec/jobs/application_job_spec.rb` - Base job tests:
  - Tests job configuration (inheritance from ActiveJob::Base, default queue name) (lines 16-24)
  - Tests retry configuration (retry_on, discard_on) (lines 26-52)
  - Tests job enqueueing (perform_later, with arguments, to different queues) (lines 54-76)
  - Tests job retry behavior (lines 78-93)
- `jarek-va/spec/support/sidekiq.rb` - Sidekiq test helpers:
  - Clears ActiveJob test queue before each test (lines 4-9)
  - Includes ActiveJob testing helpers (line 12)
- Note: `jarek-va/spec/routes/sidekiq_routes_spec.rb` (Sidekiq Web UI tests) is not applicable - we don't have a queue system

**Node.js Implementation:**

- Create `tests/unit/handlers/async.test.ts` to test async configuration and operations
- Create `tests/unit/handlers/base-async-handler.test.ts` to test base handler functionality
- Test async configuration (default options, environment-specific settings)
- Test async operations with various arguments
- Test async operation completion
- Test retry behavior and error handling
- Test async error handlers (from PHASE2-016)
- Use Jest mocks and async testing utilities for isolated testing

## Checklist

- [ ] Create `tests/unit/handlers/async.test.ts` file
  - [ ] Test async configuration:
    - [ ] Test async configuration loading (equivalent to Sidekiq module loading)
    - [ ] Test async utilities (`withRetry`, `withTimeout`, `withConcurrencyLimit` from PHASE2-014)
    - [ ] Test default async options (retry: 3, exponential backoff) - matching Rails `retry: 3`
    - [ ] Test environment-specific async configuration (development, test, production) - from async config (PHASE2-013)
  - [ ] Test async operations:
    - [ ] Test async operation execution
    - [ ] Test async operation with various argument types
    - [ ] Test async operation options (retry, timeout)
    - [ ] Test async error handling (from PHASE2-016)
- [ ] Create `tests/unit/handlers/base-async-handler.test.ts` file
  - [ ] Test base handler class:
    - [ ] Test handler class structure (abstract base class pattern)
    - [ ] Test default handler name/identifier
    - [ ] Test handler name override capability
    - [ ] Test handler function signature
  - [ ] Test async handler execution:
    - [ ] Test handler execution with arguments
    - [ ] Test storing handler arguments correctly
    - [ ] Test handler execution with different argument types
    - [ ] Test handler options when executing (retry, timeout)
  - [ ] Test handler processing:
    - [ ] Test handler execution with valid data
    - [ ] Test handler with different argument types
    - [ ] Test handler completion and result handling
  - [ ] Test retry behavior:
    - [ ] Test retry configuration (3 attempts, exponential backoff)
    - [ ] Test retry on StandardError
    - [ ] Test discard on specific errors (DeserializationError equivalent)
    - [ ] Test retry delay calculation (exponential backoff)
- [ ] Create `tests/unit/handlers/async-error-handler.test.ts` file
  - [ ] Test async error handlers (from PHASE2-016):
    - [ ] Test error handling wrapper attachment
    - [ ] Test error classification (retryable vs non-retryable)
    - [ ] Test failed operation handler for exhausted retries
    - [ ] Test completed operation handler for successful operations
    - [ ] Test timeout error handling
  - [ ] Test error logging:
    - [ ] Test error logs include operation identifier, error message, stack trace
    - [ ] Test failed operation logs include full context (attempts, error details, operation data)
    - [ ] Test logging uses application logger utility
- [ ] Create integration test `tests/integration/handlers/async-integration.test.ts`:
  - [ ] Test end-to-end async operation flow (execute → process → complete)
  - [ ] Test async retry flow (execute → fail → retry → complete)
  - [ ] Test multiple async operations executing concurrently
  - [ ] Test async error handling in real scenarios
- [ ] Add test utilities and helpers:
  - [ ] Create `tests/helpers/asyncHelpers.ts` for async test utilities
  - [ ] Create mock async handlers for testing
  - [ ] Create helper functions to create test async operations
  - [ ] Create helper functions to wait for async operation completion
  - [ ] Create helper functions to test retry behavior

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 3. Async Processing Setup
- **Rails Files to Reference:**
  - `jarek-va/spec/config/sidekiq_spec.rb` - Sidekiq configuration tests:
    - Lines 6-12: Sidekiq module loading and configuration methods (test async configuration loading)
    - Lines 14-22: Default job options (retry: 3, backtrace: true) - test async default options
    - Lines 24-30: Redis URL configuration from environment - NOT APPLICABLE (we don't use Redis for queues)
    - Lines 33-50: ActiveJob adapter configuration - NOT APPLICABLE (we use native async, not an adapter)
    - Lines 53-68: Sidekiq YAML configuration file tests - NOT APPLICABLE (we use TypeScript config files; test environment-specific settings from async config instead)
  - `jarek-va/spec/jobs/application_job_spec.rb` - Base job tests:
    - Lines 16-24: Job configuration (inheritance, default queue name) - test BaseAsyncHandler class structure
    - Lines 26-52: Retry and discard configuration - test retry/discard logic in base async handler
    - Lines 54-76: Job enqueueing tests (with arguments, different queues) - test async handler execution with various arguments
    - Lines 78-93: Job retry behavior tests - test retry behavior with async utilities
  - `jarek-va/spec/support/sidekiq.rb` - Sidekiq test helpers:
    - Lines 4-9: Clear ActiveJob test queue before each test - NOT APPLICABLE (we don't have queues)
    - Line 12: Include ActiveJob testing helpers - create async test utilities
  - Note: `jarek-va/spec/routes/sidekiq_routes_spec.rb` is NOT APPLICABLE - we don't have a queue system
- **Dependencies:**
  - Requires async utilities (completed in PHASE2-014)
  - Requires async configuration (completed in PHASE2-013)
  - Requires base async handler (completed in PHASE2-015)
  - Requires async error handling (completed in PHASE2-016)
- **Implementation Details:**
  - Use Jest as the test framework (already configured in telegram-receiver)
  - Use Jest mocks and async testing utilities for isolated testing
  - For unit tests, mock async operations and handlers
  - For integration tests, use actual async operations
  - Test helpers should clean up any test state between tests
  - Use `waitFor` or similar patterns to wait for async operation completion
  - Test error scenarios: operation errors, retry exhaustion, timeout errors
  - Test success scenarios: async operation execution, completion
  - Test configuration: default options, environment-specific settings
- **Key Differences from Rails:**
  - Rails: Uses ActiveJob::TestHelper for testing (clears queues automatically)
  - Node.js: Must manually clean up test state (implement in asyncHelpers.ts)
  - Rails: Sidekiq tests use ActiveJob test adapter in test environment
  - Node.js: Uses native async/await patterns (no adapter pattern)
  - Rails: Tests can use `have_enqueued_job` matchers
  - Node.js: Must check operation state directly or use Promise-based patterns
  - Rails: Sidekiq has built-in Web UI (tested in sidekiq_routes_spec.rb)
  - Node.js: No queue system, so no web UI tests needed
  - Rails: Sidekiq uses YAML configuration file (sidekiq.yml)
  - Node.js: Uses TypeScript configuration files (no YAML config to test)
- **Testing Patterns:**
  - Unit tests: Mock async handlers and utilities, test configuration and options
  - Integration tests: Use real async handlers and utilities
  - Test helpers: Create reusable functions for common test operations
  - Cleanup: Always clean up test state after tests to prevent test pollution
- **Test Coverage Goals:**
  - Async configuration: 100% coverage
  - Async operation execution: 100% coverage
  - Async handler processing: 100% coverage
  - Error handling: 100% coverage
  - Retry behavior: 100% coverage
- Task can be completed independently by a single agent (after PHASE2-013, PHASE2-014, PHASE2-015, and PHASE2-016 are complete)

## Related Tasks

- Previous: PHASE2-016
- Next: PHASE2-018

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

