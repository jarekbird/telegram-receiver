# PHASE2-082: Implement transcribe_audio method

**Section**: 10. TelegramMessageJob Conversion
**Subsection**: 10.6
**Task ID**: PHASE2-082

## Description

Convert the `transcribe_audio` method from Rails to TypeScript/Node.js. This method transcribes audio files from Telegram messages using the ElevenLabs Speech-to-Text API. Reference `jarek-va/app/jobs/telegram_message_job.rb` lines 315-352.

## Checklist

- [ ] Create `transcribeAudio` method with signature: `transcribeAudio(fileId: string, chatId: number, messageId: number): Promise<string>`
- [ ] Send optional status message "ðŸŽ¤ Transcribing audio..." if cursor debug is enabled (check SystemSetting for 'debug')
- [ ] Wrap status message sending in try-catch that logs errors but doesn't propagate (transcription must proceed even if status message fails)
- [ ] Download audio file from Telegram using `TelegramService.downloadFile(fileId)` - returns file path
- [ ] Transcribe audio using `ElevenLabsSpeechToTextService.transcribe(audioPath)` - returns transcribed text
- [ ] Return transcribed text string
- [ ] Implement file cleanup in finally/ensure block to delete downloaded audio file (always runs, even on error)
- [ ] Handle errors appropriately - method should propagate errors to caller (caller handles error messages to user)
- [ ] Log operations: file download, transcription success, file cleanup

## Implementation Details

### Method Signature

```typescript
private async transcribeAudio(
  fileId: string,
  chatId: number,
  messageId: number
): Promise<string>
```

### Key Implementation Points

1. **Status Message (Optional)**: If cursor debug is enabled (check `SystemSetting.enabled('debug')`), send a status message "ðŸŽ¤ Transcribing audio..." to the user before starting transcription.
   - **Important**: Wrap status message sending in try-catch that logs errors but does NOT propagate them
   - If status message sending fails, transcription should still proceed
   - This ensures transcription isn't blocked by status message failures

2. **File Download**: Use `TelegramService.downloadFile(fileId)` which:
   - Gets file info from Telegram API
   - Downloads file to temp directory
   - Returns the local file path

3. **Transcription**: Use `ElevenLabsSpeechToTextService.transcribe(audioPath)` which:
   - Takes the local file path
   - Uploads to ElevenLabs API
   - Returns transcribed text string

4. **File Cleanup**: Always clean up the downloaded file in a finally block:
   - Check if file exists before deleting
   - Log cleanup operations
   - Handle cleanup errors gracefully (log warning, don't throw)

5. **Error Handling**:
   - Status message errors: Catch and log, but do NOT propagate (transcription must proceed)
   - Download/transcription errors: Propagate to caller (caller handles user error messages)
   - Cleanup errors: Catch and log warnings, do NOT propagate (cleanup failures shouldn't block method completion)
   - The caller (`handleMessage` method) handles sending error messages to users for download/transcription failures

### Dependencies

- `TelegramService.downloadFile(fileId: string): Promise<string>` - Downloads file and returns local path
- `ElevenLabsSpeechToTextService.transcribe(audioPath: string): Promise<string>` - Transcribes audio file
- `SystemSetting.enabled(key: string): boolean` - Check if debug mode is enabled
- `TelegramService.sendMessage()` - Send status/error messages

### Rails Implementation Reference

Located at `jarek-va/app/jobs/telegram_message_job.rb` lines 315-352. The method:

- Sends status message if debug enabled (lines 317-328) - wrapped in begin/rescue that catches and logs errors without propagating
- Downloads file using `TelegramService.download_file(file_id)` (line 333)
- Transcribes using `ElevenLabsSpeechToTextService.new.transcribe(audio_path)` (line 338)
- Returns transcribed text (line 340)
- Cleans up file in ensure block (lines 341-350) - wrapped in begin/rescue that catches and logs cleanup errors without propagating

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 10. TelegramMessageJob Conversion
- The method is called from `handleMessage` when an audio/voice message is detected
- Errors are handled by the caller, not within this method
- File cleanup must always occur, even if transcription fails
- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-081
- Next: PHASE2-083

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

