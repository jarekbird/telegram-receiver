# PHASE2-081: Implement extract_audio_file_id utility

**Section**: 10. TelegramMessageJob Conversion
**Subsection**: 10.5
**Task ID**: PHASE2-081

## Description

Convert the `extract_audio_file_id` utility method from Rails to TypeScript/Node.js. This function extracts audio file IDs from Telegram messages, supporting voice messages, audio files, and audio documents. Reference `jarek-va/app/jobs/telegram_message_job.rb` lines 298-312.

The function checks for audio content in three ways, in this specific order:

1. **Voice messages** (most common for speech) - checks `message.voice.file_id` if `message.voice` exists
2. **Audio files** - checks `message.audio.file_id` if `message.audio` exists
3. **Documents with audio mime types** - checks `message.document.file_id` if `message.document` exists AND `message.document.mime_type` starts with `'audio/'`

**Implementation Notes:**

- The function should check these conditions in the order listed above (voice first, then audio, then document)
- Use optional chaining (`?.`) or equivalent safe navigation to handle missing properties
- Return the `file_id` string if found, or `null`/`undefined` if no audio content is detected
- The function should handle null/undefined message parameter gracefully
- For documents, only return the file_id if the mime_type starts with the string `'audio/'` (case-sensitive check)

## Checklist

- [ ] Create `extractAudioFileId` private method in TelegramMessageJob class with signature: `extractAudioFileId(message: TelegramMessage | null | undefined): string | null | undefined`
- [ ] Check for `message.voice.file_id` FIRST (voice messages) - return immediately if found
- [ ] Check for `message.audio.file_id` SECOND (audio files) - return immediately if found
- [ ] Check for `message.document.file_id` THIRD when `document.mime_type` starts with `'audio/'` (audio documents) - return immediately if found
- [ ] Return `file_id` string if found, or `null`/`undefined` if no audio content is detected
- [ ] Handle null/undefined message parameter gracefully (return null/undefined)
- [ ] Handle missing nested properties safely using optional chaining (`?.`) or equivalent
- [ ] Ensure checks are performed in the correct order (voice → audio → document)
- [ ] For document check, verify `mime_type` exists and starts with `'audio/'` before returning file_id

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 10. TelegramMessageJob Conversion
- Reference the Rails implementation for behavior
- This is a private method of the TelegramMessageJob class (not a separate utility file)
- The method is used internally by `handleMessage` to detect audio content before transcription
- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-080
- Next: PHASE2-082

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

