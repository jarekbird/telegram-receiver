# PHASE2-078: Implement process method (main entry point)

**Section**: 10. TelegramMessageJob Conversion
**Subsection**: 10.2
**Task ID**: PHASE2-078

## Description

Convert the `process` method (main entry point) from Rails to TypeScript/Node.js. This method is the equivalent of Rails' `perform` method and serves as the main entry point for processing Telegram updates. It parses the update payload, routes to appropriate handlers, and implements comprehensive error handling.

Reference: `jarek-va/app/jobs/telegram_message_job.rb` (lines 15-51)

## Checklist

- [ ] Implement `process(update)` method as the main entry point
  - [ ] Accept update parameter (can be object or JSON string)
  - [ ] Parse JSON string if update is a string type
  - [ ] Normalize update object (TypeScript equivalent of Rails' `with_indifferent_access`)
  - [ ] Log the update with full inspection for debugging (format: "TelegramMessageJob processing update: {update.inspect or JSON.stringify}")
  - [ ] Route to appropriate handler based on update type:
    - [ ] If `update.message` exists → call `handleMessage(update.message)`
    - [ ] Else if `update.edited_message` exists → call `handleMessage(update.edited_message)` (note: uses same handler as message)
    - [ ] Else if `update.callback_query` exists → call `handleCallbackQuery(update.callback_query)`
    - [ ] Else → log unhandled update types with available keys
  - [ ] Wrap entire method in try-catch for error handling
  - [ ] On error:
    - [ ] Log error message and full stack trace (include "Error in TelegramMessageJob:" prefix in log message)
    - [ ] Extract chat info from update using `extractChatInfoFromUpdate(update)` (returns [chatId, messageId] tuple)
    - [ ] Check if chat_id is truthy (not null, not undefined, not empty string) before sending error message
    - [ ] If chat_id is available, send user-friendly error message to Telegram
    - [ ] Use TelegramService.sendMessage() with error details:
      - [ ] chat_id: extracted chat_id
      - [ ] text: "Sorry, I encountered an error processing your message: {error.message}"
      - [ ] reply_to_message_id: extracted message_id (can be null/undefined, Telegram API accepts optional)
      - [ ] parse_mode: 'HTML'
    - [ ] Wrap TelegramService.sendMessage() call in try-catch to handle errors when sending error message (log error but don't fail)
    - [ ] Re-throw original error to allow async retry logic to handle it (if using retry utilities)

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 10. TelegramMessageJob Conversion
- Reference the Rails implementation for behavior: `jarek-va/app/jobs/telegram_message_job.rb` (lines 15-51)

### Key Implementation Details

- **Method Name**: In Rails, this is called `perform`, but in TypeScript/Node.js it should be named `process` to match the task naming convention
- **Update Parsing**: The update can come as either a JSON string or an object. Must parse if string using `JSON.parse()`, then normalize the object structure to allow both string and number key access (equivalent to Rails' `with_indifferent_access`)
- **Handler Routing**:
  - Both `message` and `edited_message` use the same `handleMessage()` handler
  - `callback_query` uses `handleCallbackQuery()` handler
  - Unhandled update types are logged but don't cause errors
- **Error Handling**:
  - Comprehensive error handling is critical - errors should be logged, user should be notified via Telegram if possible
  - Error log format: "Error in TelegramMessageJob: {error.message}" followed by full stack trace
  - Error message format sent to Telegram: "Sorry, I encountered an error processing your message: {error.message}"
  - chat_id check: Use truthy check (not null, not undefined, not empty string) equivalent to Rails' `.present?` method
  - reply_to_message_id is optional and can be null/undefined (Telegram API accepts optional reply_to_message_id)
  - Must re-throw original error after handling to mark job as failed for retry logic
- **Dependencies**:
  - Requires `extractChatInfoFromUpdate()` method (should be implemented in PHASE2-077 or as a utility)
  - Requires `TelegramService.sendMessage()` method
  - Requires logging utilities

### Dependencies

This method depends on:

- `handleMessage()` method (implemented in PHASE2-079)
- `handleCallbackQuery()` method (implemented in later task)
- `extractChatInfoFromUpdate()` utility method
- `TelegramService` for sending error messages
- Logging utilities

### Task Scope

- Task can be completed independently by a single agent
- However, ensure dependent methods (`handleMessage`, `handleCallbackQuery`, `extractChatInfoFromUpdate`) are available or can be stubbed for testing

## Related Tasks

- Previous: PHASE2-077
- Next: PHASE2-079

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

