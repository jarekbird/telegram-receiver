# PHASE2-061: Implement admin authentication middleware

**Section**: 8. TelegramController Conversion
**Subsection**: 8.7
**Task ID**: PHASE2-061

## Description

Convert the admin authentication middleware from Rails to TypeScript/Node.js. This middleware protects admin endpoints (set_webhook, webhook_info, delete_webhook) by validating the admin secret.

**Rails Implementation Reference:**

- Controller: `jarek-va/app/controllers/telegram_controller.rb` (lines 110-130)
- Configuration: `jarek-va/config/application.rb` (lines 22-25)
- Used in endpoints: `set_webhook` (line 52), `webhook_info` (line 74), `delete_webhook` (line 92)

**Rails Implementation Details:**

- The `authenticate_admin` method is a protected method in TelegramController (lines 110-130)
- Checks for admin secret from multiple sources (in order):
  1. `request.headers['X-Admin-Secret']` (header)
  2. `request.env['HTTP_X_ADMIN_SECRET']` (Rails-specific: Rails exposes headers via env vars with HTTP\_ prefix)
  3. `params[:admin_secret]` (query parameter as symbol)
  4. `params['admin_secret']` (query parameter as string)
- Compares against `Rails.application.config.webhook_secret`
- Returns boolean (true/false) - the calling code returns `401 Unauthorized` if false
- Has debug logging in test environment when authentication fails (logs secret values, headers, env vars, and params)
- The secret is configured in `application.rb` (lines 22-25) from Rails credentials or ENV variable `WEBHOOK_SECRET` (defaults to 'changeme')

**Express/Node.js Implementation Notes:**

- Express middleware should follow the standard Express middleware pattern: `(req, res, next) => {}`
- On authentication success: call `next()` to proceed to the next middleware/route handler
- On authentication failure: send `401 Unauthorized` response using `res.status(401).send()` or `res.status(401).json()`
- Express headers are accessible via `req.headers['x-admin-secret']` (Express normalizes header names to lowercase)
- Express does NOT automatically convert headers to environment variables like Rails does - check `req.headers` directly
- Query parameters are accessible via `req.query.admin_secret`
- The webhook_secret should be accessed from application configuration (similar to Rails `config.webhook_secret`)

## Checklist

- [ ] Create `authenticateAdmin` Express middleware function in `src/middleware/` directory
- [ ] Implement Express middleware signature: `(req: Request, res: Response, next: NextFunction) => void`
- [ ] Check for admin secret from multiple sources (in order):
  - [ ] `req.headers['x-admin-secret']` (Express normalizes headers to lowercase)
  - [ ] `req.query.admin_secret` (query parameter)
- [ ] Get expected secret from application configuration (access webhook_secret from config, similar to Rails `Rails.application.config.webhook_secret`)
- [ ] Compare provided secret with expected secret (use secure comparison if available)
- [ ] On authentication success: call `next()` to proceed to route handler
- [ ] On authentication failure: send `401 Unauthorized` response using `res.status(401).send()` or `res.status(401).json()`
- [ ] Add debug logging in test/development mode when authentication fails (log secret values, headers, and query params)
- [ ] Export middleware function for use in route handlers
- [ ] Ensure middleware can be applied to admin routes (set_webhook, webhook_info, delete_webhook)

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 8. TelegramController Conversion
- Reference the Rails implementation for behavior

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-060
- Next: PHASE2-062

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

