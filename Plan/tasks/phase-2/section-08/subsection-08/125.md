# PHASE2-062: Add error handling to TelegramController

**Section**: 8. TelegramController Conversion
**Subsection**: 8.8
**Task ID**: PHASE2-062

## Description

Add comprehensive error handling to all TelegramController handler methods. This task ensures that all endpoints (`webhook`, `setWebhook`, `getWebhookInfo`, `deleteWebhook`) have proper error handling that matches the Rails implementation behavior.

**Rails Implementation Reference**: `jarek-va/app/controllers/telegram_controller.rb`

**Key Error Handling Patterns**:

- **webhook handler** (lines 26-48): Must always return 200 OK to Telegram, extract chat info, attempt to send error message to user
- **Admin handlers** (`set_webhook`, `webhook_info`, `delete_webhook`): Return JSON error responses with 500 status, log errors

## Checklist

### Error Handling for `webhook` Handler

- [ ] Wrap handler logic in try-catch block
- [ ] Catch all errors (StandardError equivalent)
- [ ] Log error message using logger: `"Error handling Telegram webhook: #{error.message}"`
- [ ] Log error stack trace using logger (convert backtrace array to string)
- [ ] Convert update to plain object if needed (handle Hash/object conversion like Rails: `update.is_a?(Hash) ? update : update.to_h`)
- [ ] Extract chat info from update using `extractChatInfoFromUpdate` helper method (from PHASE2-063)
- [ ] If chat_id is available, attempt to send error message to user via TelegramService:
  - [ ] Use `TelegramService.sendMessage()` with error message text: `"Sorry, I encountered an error processing your message: #{error.message}"`
  - [ ] Include `reply_to_message_id` if available
  - [ ] Include `parse_mode: 'HTML'` parameter
  - [ ] Wrap TelegramService call in try-catch to handle send failures gracefully
  - [ ] Log send error if TelegramService call fails: `"Error sending error message: #{send_error.message}"`
- [ ] Always return 200 OK status to Telegram (even on error) to prevent retries
- [ ] Reference Rails implementation lines 26-48 for exact behavior

### Error Handling for Admin Handlers (`setWebhook`, `getWebhookInfo`, `deleteWebhook`)

- [ ] Wrap each handler method in try-catch block
- [ ] Catch all errors (StandardError equivalent)
- [ ] Log error message using logger with format: `"Error [operation]: #{error.message}"` (e.g., "Error setting webhook: ...")
- [ ] Log error stack trace using logger (convert backtrace array to string)
- [ ] Return JSON error response: `{ ok: false, error: error.message }` with HTTP 500 status
- [ ] Ensure error handling doesn't interfere with admin authentication checks (401 responses)
- [ ] Error handling should be placed after authentication checks (authentication failures return 401, not 500)
- [ ] Reference Rails implementation:
  - `set_webhook`: lines 64-70
  - `webhook_info`: lines 82-88
  - `delete_webhook`: lines 100-106

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 8. TelegramController Conversion
- **Important**: The `webhook` handler has special error handling requirements - it must always return 200 OK to Telegram to prevent retries, even when errors occur
- Admin handlers (`setWebhook`, `getWebhookInfo`, `deleteWebhook`) return JSON error responses with 500 status
- The `extractChatInfoFromUpdate` helper method is implemented in PHASE2-063 - use it if available, otherwise implement inline for this task
- **Update Conversion**: The update object may need to be converted to a plain object before passing to `extractChatInfoFromUpdate` (Rails uses `update.is_a?(Hash) ? update : update.to_h`)
- **Error Message Format**: When sending error messages to Telegram users, use the exact format: `"Sorry, I encountered an error processing your message: #{error.message}"` with `parse_mode: 'HTML'`
- Error logging should use the application logger (not console.log)
- Log both error message and full stack trace for debugging purposes
- When sending error messages to Telegram users, wrap the TelegramService call in its own try-catch to prevent error handling failures from causing additional errors
- Admin handler error messages should include the operation name in the log message (e.g., "Error setting webhook:", "Error getting webhook info:", "Error deleting webhook:")
- Reference the Rails implementation (`jarek-va/app/controllers/telegram_controller.rb`) for exact error handling patterns
- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-061
- Next: PHASE2-063

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

