# PHASE2-071: Implement format_success_message utility

**Section**: 9. CursorRunnerCallbackController Conversion
**Subsection**: 9.7
**Task ID**: PHASE2-071

## Description

Convert and implement the `format_success_message` utility function from Rails to TypeScript/Node.js. This utility function formats success messages for cursor-runner callback results, including metadata (when debug is enabled), output with truncation, and warnings.

**Rails Reference**: `jarek-va/app/controllers/cursor_runner_callback_controller.rb` (lines 261-267)

## Checklist

- [ ] Create `formatSuccessMessage` utility function with signature: `(result: NormalizedResult, cursorDebug: boolean): string`
- [ ] Create helper function `formatMetadata(result: NormalizedResult): string[]` that returns:
  - `'‚úÖ Cursor command completed successfully'`
  - `'üìä Iterations: {result.iterations || 0}'`
  - `'‚è± Duration: {result.duration || 'N/A'}'`
- [ ] Create helper function `formatOutput(output: string, cursorDebug: boolean): string` that:
  - Uses `cleanAnsiEscapeSequences` (PHASE2-073) to clean the output
  - Sets max_length: `cursorDebug ? 3500 : 4000`
  - If output length > max_length:
    - Truncates to max_length
    - If cursorDebug: returns `'\nüìù Output (truncated):\n<pre><code>{truncated}\n...</code></pre>'`
    - If not cursorDebug: returns `'{truncated}\n...'`
  - Else if cursorDebug: returns `'\nüìù Output:\n<pre><code>{cleaned_output}</code></pre>'`
  - Else: returns cleaned_output
- [ ] Create helper function `formatWarnings(error: string, cursorDebug: boolean): string` that:
  - Uses `cleanAnsiEscapeSequences` (PHASE2-073) to clean the error text
  - Truncates error to 500 characters if longer: take first 500 characters using `errorText.substring(0, 500)` and append `'...'` (Rails equivalent: `error_text[0, 500]`)
  - Returns `'\n‚ö†Ô∏è Warnings:\n<pre><code>{error_text}</code></pre>'`
- [ ] Implement main `formatSuccessMessage` function logic:
  - Create empty array `messageParts: string[]`
  - If `cursorDebug` is true: concatenate `formatMetadata(result)` array to messageParts
  - If `result.output` is present/truthy: append `formatOutput(result.output, cursorDebug)` to messageParts
  - If `cursorDebug` is true AND `result.error` is present/truthy: append `formatWarnings(result.error, cursorDebug)` to messageParts
  - Join messageParts with `'\n'` and return as string
- [ ] Handle edge cases:
  - Empty/undefined output should not add output section
  - Empty/undefined error should not add warnings section
  - Empty messageParts should return empty string

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 9. CursorRunnerCallbackController Conversion
- **Rails Implementation**: `jarek-va/app/controllers/cursor_runner_callback_controller.rb` (lines 261-267, 274-280, 282-300, 302-307)
- The function is called from `sendResponseToTelegram` method (PHASE2-070) when `result.success` is true
- The `result` parameter is a `NormalizedResult` object (from `normalizeResult` utility - PHASE2-069) with the following structure:
  - `success: boolean` - indicates if cursor command succeeded
  - `request_id: string` - request identifier
  - `repository?: string` - repository name
  - `branch_name?: string` - branch name
  - `iterations: number` - number of iterations (defaults to 0)
  - `max_iterations: number` - max iterations (defaults to 25)
  - `output?: string` - command output (defaults to empty string)
  - `error?: string` - error message if failed (used for warnings when success is true)
  - `exit_code: number` - exit code (defaults to 0)
  - `duration?: string` - execution duration
  - `timestamp?: string` - timestamp
- The `cursorDebug` parameter determines:
  - Whether to include metadata (iterations, duration)
  - Whether to include warnings from error field
  - Output formatting style (HTML code blocks vs plain text)
  - Output truncation length (3500 vs 4000 characters)
- **Dependencies**:
  - `cleanAnsiEscapeSequences` utility (PHASE2-073) - used by `formatOutput` and `formatWarnings` helper functions
  - `NormalizedResult` type (from PHASE2-069)
- **Helper Functions**: This task should implement three helper functions:
  - `formatMetadata` - formats metadata lines (iterations, duration)
  - `formatOutput` - formats output with ANSI cleaning, truncation, and HTML code blocks
  - `formatWarnings` - formats warnings from error field with ANSI cleaning and truncation
- HTML code blocks (`<pre><code>...</code></pre>`) are used for better compatibility with Telegram's Markdown/HTML parsing
- The function returns a string that will be sent to Telegram via `TelegramService.sendMessage()`
- The function should be placed in an appropriate utilities module/file, such as `src/utils/format-messages.ts` or similar (consider grouping with `formatErrorMessage` from PHASE2-072)
- Task can be completed independently by a single agent (after PHASE2-073 is complete for `cleanAnsiEscapeSequences` dependency)

## Related Tasks

- Previous: PHASE2-070
- Next: PHASE2-072

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

