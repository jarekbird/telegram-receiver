# PHASE2-074: Implement send_text_as_audio method

**Section**: 9. CursorRunnerCallbackController Conversion
**Subsection**: 9.10
**Task ID**: PHASE2-074

## Description

Convert the `send_text_as_audio` private method from Rails to TypeScript/Node.js. This method converts text to speech using ElevenLabs and sends it as a voice message via Telegram.

**Rails Reference**: `jarek-va/app/controllers/cursor_runner_callback_controller.rb` (lines 221-255)

## Checklist

- [ ] Create private `sendTextAsAudio` method with signature: `(chatId: string, text: string, messageId?: number)`
- [ ] Initialize `ElevenLabsTextToSpeechService` instance (using `new` constructor)
- [ ] Call `synthesize(text)` method to generate audio file (returns file path)
- [ ] Send audio via `TelegramService.sendVoice` with parameters:
  - `chatId`: chat ID
  - `voicePath`: path to generated audio file
  - `replyToMessageId`: message ID (optional)
- [ ] Implement error handling with try-catch:
  - Log errors with full error message and stack trace
  - Fallback to `TelegramService.sendMessage` with Markdown parse_mode on error
- [ ] Implement cleanup in finally/ensure block:
  - Delete generated audio file using file system operations
  - Handle cleanup errors gracefully (log warnings, don't throw)
  - Check if file exists before attempting deletion
- [ ] Initialize `audioPath` variable as `null`/`undefined` before try block

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 9. CursorRunnerCallbackController Conversion
- **Rails Implementation Details**:
  - Method is private and called from `send_response_to_telegram` method
  - Uses `ElevenLabsTextToSpeechService.new` to create service instance
  - Calls `synthesize(text)` which returns a file path string
  - Error handling catches `StandardError` and falls back to text message with Markdown parse_mode
  - Cleanup uses `File.delete(audio_path)` in ensure block with error handling
  - Logs errors and warnings appropriately
- **TypeScript Conversion Notes**:
  - Use async/await for file operations and API calls
  - Use `fs.promises` or `fs-extra` for file operations
  - Ensure proper error handling and logging
  - Match the exact behavior: generate audio, send voice, cleanup, fallback on error

- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-073
- Next: PHASE2-075

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

