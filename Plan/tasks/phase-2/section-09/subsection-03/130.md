# PHASE2-067: Implement webhook authentication

**Section**: 9. CursorRunnerCallbackController Conversion
**Subsection**: 9.3
**Task ID**: PHASE2-067

## Description

Convert webhook authentication middleware from Rails to TypeScript/Node.js. This middleware authenticates incoming webhook requests from cursor-runner by validating a secret token.

**Rails Reference**: `jarek-va/app/controllers/cursor_runner_callback_controller.rb` (lines 72-91)

The Rails implementation:

- Checks for secret in headers (`X-Webhook-Secret` or `X-Cursor-Runner-Secret`) or query parameter (`secret`)
- Compares against configured webhook secret from `Rails.application.config.webhook_secret`
- Allows requests if secret matches or if expected secret is not configured (development mode)
- Logs warnings for unauthorized requests with secret status and IP address
- Returns 401 Unauthorized with JSON error message if authentication fails

## Checklist

- [ ] Create `authenticateWebhook` middleware function
- [ ] Check for secret in `X-Webhook-Secret` header
- [ ] Check for secret in `X-Cursor-Runner-Secret` header (alternative header name)
- [ ] Check for secret in query parameter `secret` (fallback option)
- [ ] Get expected secret from application configuration (environment variable `WEBHOOK_SECRET`)
- [ ] Compare provided secret with expected secret
- [ ] Allow request if secret matches expected secret
- [ ] Allow request if expected secret is not configured (undefined/null/empty/whitespace-only) - development mode
- [ ] Log warning message for unauthorized requests (include secret status and IP address)
- [ ] Return 401 Unauthorized status with JSON error `{ error: 'Unauthorized' }` if authentication fails
- [ ] Ensure middleware can be used as Express middleware or route handler

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 9. CursorRunnerCallbackController Conversion
- **Rails Implementation**: `jarek-va/app/controllers/cursor_runner_callback_controller.rb` (lines 72-91)
- **Configuration**: Webhook secret is configured via `Rails.application.config.webhook_secret` which reads from Rails credentials or `WEBHOOK_SECRET` environment variable (see `jarek-va/config/application.rb` lines 24-25)
- The middleware should be applied as a `before_action` equivalent (Express middleware) to protect the callback route
- In development mode, if no webhook secret is configured (undefined/null/empty/whitespace-only), all requests are allowed (blank check)
- The Rails implementation logs warnings with format: `'Unauthorized cursor-runner callback - invalid secret (provided_secret: [present|missing], ip: <ip>)'`
- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-066
- Next: PHASE2-068

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

