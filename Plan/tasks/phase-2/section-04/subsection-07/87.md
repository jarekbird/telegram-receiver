# PHASE2-024: Implement download_file method

**Section**: 4. TelegramService Conversion
**Subsection**: 4.7
**Task ID**: PHASE2-024

## Description

Convert and implement the `downloadFile` method from Rails to TypeScript/Node.js. Reference `jarek-va/app/services/telegram_service.rb`.

The Rails implementation (`download_file`) downloads files from Telegram by:

1. Getting file information from Telegram Bot API using `get_file` endpoint
2. Extracting the file path from the API response
3. Constructing the download URL using the bot token and file path
4. Downloading the file from Telegram's file server
5. Saving to a specified destination path or temporary directory if not provided
6. Returning the path to the downloaded file

## Checklist

- [ ] Implement `downloadFile(fileId: string, destinationPath?: string): Promise<string | undefined>` method
  - Return type should be `Promise<string | undefined>` to account for early return when bot token is blank (matching Rails `return` behavior which returns `nil`)
- [ ] Add early return if bot token is blank (similar to other methods in TelegramService)
  - If bot token is blank/invalid, return `undefined` immediately (matching Rails `return` behavior which returns `nil`)
- [ ] Call Telegram Bot API `getFile` endpoint with the file_id
- [ ] Extract `file_path` from the API response (`result.file_path`)
- [ ] Construct download URL: `https://api.telegram.org/file/bot${botToken}/${file_path}`
- [ ] Handle optional `destinationPath` parameter:
  - If provided, use it as-is
  - If not provided (undefined), create temp path using `path.join(os.tmpdir(), "telegram_${fileId}_${filename}")` where filename is extracted from `file_path` using `path.basename(file_path)` (matches Rails `File.join(Dir.tmpdir, "telegram_#{file_id}_#{filename}")`)
- [ ] Implement private helper method `downloadFileFromUrl(url: string, destinationPath: string): Promise<void>`
  - Use `axios` or `node:https`/`node:http` to download the file
  - Ensure parent directory exists using `fs.mkdir` with `path.dirname(destinationPath)` and `{ recursive: true }` option (matches Rails `FileUtils.mkdir_p(File.dirname(destination_path))`)
  - Write file using `fs.writeFile` or `fs.promises.writeFile` with binary mode
  - Log success message with file size (similar to Rails: "Downloaded file to {path} ({size} bytes)")
  - Raise/throw error if HTTP request fails with format: "Failed to download file: HTTP {statusCode} {statusMessage}" (check status code, similar to Rails `Net::HTTPSuccess`)
- [ ] Call `downloadFileFromUrl` helper method to perform the actual download
- [ ] Return the `destinationPath` string
- [ ] Add comprehensive error handling:
  - Wrap in try-catch block
  - Log errors with context (file_id, error message)
  - Log error stack trace
  - Re-throw errors after logging
- [ ] Add logging for download start: "Downloading Telegram file {fileId} to {destinationPath}"
- [ ] Ensure method signature matches TypeScript conventions (camelCase, Promise return type)

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 4. TelegramService Conversion
- Reference the Rails implementation (`jarek-va/app/services/telegram_service.rb`) for behavior
- The Rails implementation uses a private helper method `download_file_from_url` - this should be implemented as `downloadFileFromUrl` in TypeScript
- Rails uses `Net::HTTP` for downloading - in TypeScript, use `axios` (already in dependencies) or Node.js built-in `https`/`http` modules
  - If using `axios`, set `responseType: 'arraybuffer'` or `responseType: 'stream'` to handle binary file data correctly
  - If using Node.js `https`/`http`, handle the response stream appropriately for binary data
- Rails uses `File.binwrite` for binary file writing - use `fs.writeFile` or `fs.promises.writeFile` in Node.js (no encoding specified, writes binary)
- Rails uses `Dir.tmpdir` for temp directory - use `os.tmpdir()` in Node.js
- Rails uses `FileUtils.mkdir_p` for directory creation - use `fs.mkdir` with `{ recursive: true }` in Node.js
- Rails uses `File.join` and `File.basename` and `File.dirname` - use Node.js `path.join`, `path.basename`, and `path.dirname` respectively
- The method should return the destination path string (same as Rails), or `undefined` if bot token is blank (early return)
- Return type should be `Promise<string | undefined>` to account for early return when bot token is blank (matching Rails `return` behavior which returns `nil`)
- Error handling pattern should match other TelegramService methods (early return if token blank, try-catch with logging, re-throw)
- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-023
- Next: PHASE2-025

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

