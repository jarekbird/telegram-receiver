# PHASE2-048: Add error handling to SpeechToTextService

**Section**: 7. ElevenLabs Services Conversion
**Subsection**: 7.4
**Task ID**: PHASE2-048

## Description

Add comprehensive error handling to the ElevenLabsSpeechToTextService class methods, matching the error handling patterns from the Rails implementation. This task ensures all methods properly handle network errors, timeouts, invalid responses, and transcription failures with appropriate error classes and logging. Reference `jarek-va/app/services/eleven_labs_speech_to_text_service.rb` for the complete error handling implementation.

**Rails Reference**: `jarek-va/app/services/eleven_labs_speech_to_text_service.rb`

## Checklist

### Error Handling in `build_http` method (private)

- [ ] Catch `ECONNREFUSED`, `EHOSTUNREACH`, and `SocketError` exceptions
- [ ] Raise `ConnectionError` with message "Failed to connect to ElevenLabs: {error message}"
- [ ] Catch `Net::OpenTimeout` and `Net::ReadTimeout` exceptions
- [ ] Raise `TimeoutError` with message "Request to ElevenLabs timed out: {error message}"

### Error Handling in `execute_request` method (private)

- [ ] Log request info: "ElevenLabsSpeechToTextService: POST {uri.path}"
- [ ] Log response info: "ElevenLabsSpeechToTextService: Response {code} {message}"
- [ ] Check if response is not successful (non-2xx status)
- [ ] Extract error message from response body (try JSON parsing)
- [ ] Log error: "ElevenLabs API error: {code} - Response body: {body[0..500]}"
- [ ] Parse error response JSON to extract detail/error/message fields
- [ ] Log JSON parse failure if error response cannot be parsed: "Failed to parse error response as JSON"
- [ ] Raise `TranscriptionError` with extracted error message for non-2xx responses
- [ ] Catch `Net::OpenTimeout` and `Net::ReadTimeout` exceptions
- [ ] Raise `TimeoutError` with message "Request to ElevenLabs timed out: {error message}"
- [ ] Catch `ECONNREFUSED`, `EHOSTUNREACH`, and `SocketError` exceptions
- [ ] Raise `ConnectionError` with message "Failed to connect to ElevenLabs: {error message}"

### Error Handling in `parse_response` method (private)

- [ ] Catch `JSON::ParserError` exceptions
- [ ] Raise `InvalidResponseError` with message "Failed to parse response: {error message}"

### Error Handling in `transcribe` method (public)

- [ ] Catch `Errno::ENOENT` (file not found) exceptions
- [ ] Raise base `Error` with message "Audio file not found: {error message}"
- [ ] Catch `JSON::ParserError` exceptions
- [ ] Raise `InvalidResponseError` with message "Failed to parse response: {error message}"

### Error Handling in `transcribe_io` method (public)

- [ ] Catch `JSON::ParserError` exceptions
- [ ] Raise `InvalidResponseError` with message "Failed to parse response: {error message}"

### Logging Requirements

- [ ] Log info when sending audio file: "Sending audio file to ElevenLabs for transcription: {file_path}"
- [ ] Log info when sending audio IO: "Sending audio IO to ElevenLabs for transcription: {filename}"
- [ ] Log info on successful transcription: "Successfully transcribed audio: {text[0..50]}..."
- [ ] Log error for API errors with response code and body preview
- [ ] Log error when JSON parsing fails for error responses

## Notes

- This task is part of Phase 2: File-by-File Conversion
- Section: 7. ElevenLabs Services Conversion
- **Rails Implementation**: `jarek-va/app/services/eleven_labs_speech_to_text_service.rb` (lines 109-155 for private methods, lines 32-66 and 73-103 for public methods)
- Error classes (Error, ConnectionError, TimeoutError, InvalidResponseError, TranscriptionError) should already be defined from PHASE2-045
- This task adds error handling to methods that should already be implemented (transcribe from PHASE2-046, transcribe_io from PHASE2-047)
- Error handling should be integrated into existing method implementations, not added as separate methods
- **Error Propagation**: Connection and timeout errors from `build_http` and `execute_request` will naturally propagate to the public methods (`transcribe` and `transcribe_io`) without needing explicit catch blocks in those methods. Only specific errors (like `Errno::ENOENT` for file operations and `JSON::ParserError` from `parse_response`) need explicit handling in the public methods.
- In TypeScript/Node.js, equivalent error types:
  - `ECONNREFUSED`, `EHOSTUNREACH`, `SocketError` → Network connection errors (use appropriate Node.js error types like `ECONNREFUSED`, `EHOSTUNREACH`, or generic `Error` with appropriate error codes)
  - `Net::OpenTimeout`, `Net::ReadTimeout` → Request timeout errors (use fetch/axios timeout handling or AbortController with timeout)
  - `JSON::ParserError` → JSON parsing errors (use try-catch around JSON.parse)
  - `Errno::ENOENT` → File not found errors (use fs.access or fs.stat with error handling, or catch `ENOENT` error code)
- Logging should use the application's logger (similar to Rails.logger)
- Task can be completed independently by a single agent

## Related Tasks

- Previous: PHASE2-047
- Next: PHASE2-049

## Definition of Done

This document defines the criteria for task completion. The review agent uses these definitions to evaluate whether a task has been completed successfully.

### 1. CODE/FILE WRITING TASKS

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**Examples**:
- Creating new source code files
- Modifying existing source code files
- Implementing features, functions, classes, modules
- Writing tests, specs
- Refactoring code
- Fixing bugs in source code

### 2. SYSTEM/ENVIRONMENT OPERATION TASKS

**Description**: Tasks involving installing dependencies, running builds, installing packages, running migrations, executing install scripts, etc.

**Definition of Done**: "The required operation must complete successfully with no errors, and the expected artifacts must be created. If any part of the operation fails, the task is NOT complete."

**Important Notes**:
- Installing dependencies requires packages to actually be installed successfully
- Updating package.json is NOT enough
- If the output mentions environmental issues, errors, warnings, or failed operations, the task is NOT complete

**Examples**:
- Installing npm packages, pip packages, gem dependencies
- Running database migrations
- Building/compiling projects
- Setting up development environments
- Running install scripts

