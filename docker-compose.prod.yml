services:
  # Redis service for BullMQ job queue
  # Note: Redis must run as a master (not replica) for BullMQ to work
  # If you see "READONLY" errors, the shared_redis_data volume may contain replica config
  # In that case, remove the volume: docker volume rm shared_redis_data
  redis:
    image: redis:7-alpine
    container_name: telegram-receiver-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    # Do NOT expose Redis port 6379 in production (Redis is accessed internally via Docker network)
    volumes:
      # Shared Redis data volume accessible by all services
      - shared_redis_data:/data
    networks:
      - virtual-assistant-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Node.js/TypeScript application service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-receiver-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - REDIS_URL=redis://redis:6379/0
      - CURSOR_RUNNER_URL=http://cursor-runner:3001
      - CURSOR_RUNNER_TIMEOUT=${CURSOR_RUNNER_TIMEOUT:-300}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - LOG_LEVEL=info
      - APP_NAME=${APP_NAME:-Virtual Assistant API}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-changeme}
      - TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-changeme}
      - TELEGRAM_WEBHOOK_BASE_URL=${TELEGRAM_WEBHOOK_BASE_URL}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - ELEVENLABS_STT_MODEL_ID=${ELEVENLABS_STT_MODEL_ID}
      - ELEVENLABS_TTS_MODEL_ID=${ELEVENLABS_TTS_MODEL_ID}
      - ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID}
      - DEFAULT_NOTES_REPOSITORY=${DEFAULT_NOTES_REPOSITORY}
    volumes:
      # Mount shared SQLite database for cross-service access
      - shared_sqlite_db:/app/shared_db
      # Mount logs for debugging (optional)
      - ./log:/app/log
    networks:
      - virtual-assistant-network
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # BullMQ worker service for background jobs
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-receiver-worker
    restart: unless-stopped
    # Note: The worker script/entry point must be created separately
    # For now, using placeholder command - update when worker.js is implemented
    command: node dist/worker.js
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379/0
      - CURSOR_RUNNER_URL=http://cursor-runner:3001
      - CURSOR_RUNNER_TIMEOUT=${CURSOR_RUNNER_TIMEOUT:-300}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - LOG_LEVEL=info
      - APP_NAME=${APP_NAME:-Virtual Assistant API}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-changeme}
      - TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-changeme}
      - TELEGRAM_WEBHOOK_BASE_URL=${TELEGRAM_WEBHOOK_BASE_URL}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - ELEVENLABS_STT_MODEL_ID=${ELEVENLABS_STT_MODEL_ID}
      - ELEVENLABS_TTS_MODEL_ID=${ELEVENLABS_TTS_MODEL_ID}
      - ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID}
      - DEFAULT_NOTES_REPOSITORY=${DEFAULT_NOTES_REPOSITORY}
    volumes:
      # Mount shared SQLite database for cross-service access
      - shared_sqlite_db:/app/shared_db
      # Mount logs for debugging (optional)
      - ./log:/app/log
    networks:
      - virtual-assistant-network
    depends_on:
      - redis
      - app

volumes:
  # Shared Redis data volume accessible by all services
  shared_redis_data:
    driver: local
    name: shared_redis_data
  # Shared SQLite database volume accessible by all services
  shared_sqlite_db:
    driver: local
    name: shared_sqlite_db

networks:
  virtual-assistant-network:
    external: true
    name: virtual-assistant-network
